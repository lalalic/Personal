<!DOCTYPE HTML>
<html>
	<head>
		<script src="openxml.js"></script>
		<script src="docx.js"></script>
		<script src="docx2html.js"></script>
		<script type="text/javascript" src="http://cdn.aloha-editor.org/latest/lib/require.js"></script>
        <script type="text/javascript" src="http://cdn.aloha-editor.org/latest/lib/vendor/jquery-1.7.2.js"></script>

		<script src="./libs/zip.js"></script>
		<script src="./libs/inflate.js"></script>
		<script src="./libs/deflate.js"></script>
		<script src="./libs/zip-fs.js"></script>
		<script src="./libs/mime-types.js"></script>
<!--
		<link href="http://cdn.aloha-editor.org/latest/css/aloha.css" rel="stylesheet" type="text/css" />
		<script src="http://cdn.aloha-editor.org/latest/lib/aloha.js"
                                   data-aloha-plugins="common/ui,
                                                        common/format,
                                                        common/list,
                                                        common/link,
														common/table,
														common/image,
                                                        common/highlighteditables"></script>	
														-->
		<script>
			jQuery(function(){
				zip.useWebWorkers=false
				$(document).bind('style.traversed',function(e,rule){
					var selector=rule.selectorText.substring(7),
						sheet=rule.parentStyleSheet,
						css=rule.cssText.split('{')[1].trim().split('}')[0]
					$('<dt>'+selector+'</dt><dd><input value="'+css+'"></dd>')
						.appendTo(styles)
						.find('input')
						.change(function(){
							var i=$('#styles input').index(this), 
								rules=sheet.rules,
								rule=rules[i]
							sheet.removeRule(rule)
							sheet.insertRule(rule.selectorText+"{"+this.value+"}",i)
						})
				})
				docxFile.addEventListener('change',function(){
					var converter=new xpr.docx.out.html.HtmlConverterBuilder()
					var docx=new xpr.DOCX(this.files[0])
					docx.readThen(function(){
						workspace.removeChild(empty)
						docx.traverseWith(converter,function(){
							workspace.firstElementChild.contentEditable=true
							$('article')
								//.aloha()
								.bind('drop',function(e){
								e.preventDefault();
								e=e.originalEvent
								switch(e.dataTransfer.getData('type')){
								case 'schema':
									var dragID=e.dataTransfer.getData('dragID'),
										src=$('#'+dragID)
									if(!src.find('ul').length){
										$(e.target).append($('<var>['+src.get(0).textContent+']</var>'))
									}else{
										var html=['<table class="var"><tr>'],
											children=$(src).find('>ul>li')
										children.each(function(){
											html.push('<th>'+this.textContent+'</th>')
										})
										html.push('</tr><tr>')
										children.each(function(){
											html.push('<td><var>['+this.textContent+']</var></td>')
										})
										html.push('</tr><tr>')
										
										children.each(function(){
											html.push('<td>&nbsp;</td>')
										})
										html.push('</tr></table>')
										$(e.target).append($(html.join('')))
									}
									
								break;
								}
							}).bind('dragover',function(e){
								e.preventDefault();
							})
						})
						
					})
				},false)
				dataFile.addEventListener('change',function(){
					var reader=new FileReader(),
						handler=function(dataNode,htmlParent){
							if(dataNode.nodeType==3)
								return;
							var li=$('<li unselectable="on" draggable="true" path="'+dataNode.localName+'">'+dataNode.localName+'</li>')
							li.bind('dragstart',function(e){
								e.stopPropagation()
								this.id=this.id?this.id:new Date().getTime()
								e=e.originalEvent
								e.dataTransfer.setData('dragID',this.id)
								e.dataTransfer.setData('type','schema')
							})
							htmlParent.append(li)
							if(dataNode.firstElementChild){
								var ul=$('<ul/>'),siblings={}
								ul.appendTo(li)
								for(var i=0,ds=dataNode.childNodes,d,len=ds.length;i<len;i++){
									d=ds[i]
									if(d.nodeType==3)
										continue
									if(d.localName in siblings)
										continue
									handler(ds[i],ul)
									siblings[d.localName]=1
								}
							}
						}
					reader.onload=function(e){
						var dom=jQuery.parseXML(e.target.result).documentElement
						if(dom.firstElementChild==dom.lastElementChild)
							dom=dom.firstElementChild
						handler(dom,$(datatree))
						datatree.onclick=null
						datatree.classList.remove('dropfile')
					}
					reader.readAsText(this.files[0])
				},false)
			
				window.addEventListener('message',function(e){
					if(e.source==e.target)
						return;
					alert('get message '+e.data)
				})
			})
		</script>
		<style>
			body{background-color:lightgray}
			#ruler{
				width: 210mm;
				margin: 5px auto;
			}
			#ruler>table{
				height: 10px;
				border:0px
			}
			#ruler>table td{
				background-color:white;
				text-align:center;
				font-size:6pt;
				vertical-align:middle;
				opacity:0.5;
				border:0px
			}
			#ruler>table td:first-child,
			#ruler>table td:last-child{
				background-color:lightgray;
				
			}
			article{
				min-height: 297mm!important;
				width: 210mm;
				margin: 10px auto;
				background:white;
				border:1px solid gray;
				box-shadow: 10px 10px 5px #777777
			}
			article>div{
				padding:2.54cm 
			}
			.dropfile{
				opacity:0.5;
				background-color:white;
				background-repeat:no-repeat;
				background-position:50% 100px;
				background-image:url(https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNgekQBo9ZFYe96DW397oR_t7E0D24SbgiiSc2X892vOCfMNEn)
			}
			#styles,#datatree{
				position:fixed;
				top:20px;
				height:100%;
				width:200px;
				margin:10px 2px;
				background-color:white;
				border: 1px solid gray;
				border-radius:10px;
				overflow:hidden
			}
			#styles{right:0}
			#datatree{left:0}
			#styles dt{padding-left:10px;}
			#docxFile,#dataFile{
				position:fixed;
				top:-1000px
			}
			table{
				width:100%;
				border-collapse:collapse
			}
			td,th{
				border:1px solid gray;
			}
			th{background:lightgray}
			li{
				cursor:pointer;
			   -moz-user-select: -moz-none;
			   -khtml-user-select: none;
			   -webkit-user-select: none;
			   -ms-user-select: none;
			   user-select: none;
			}
			var{
				color:blue;
				cursor:default;
			}
			table.var:hover, var:hover{
				background-color:lightgray
			}
			article p:empty{width:1em}
			article p:empty:after{content:"\0013";}
			#styles dd input{border:0;border-bottom:1px dotted}
		</style>
	</head>
	<body>
	<input type="file" id="docxFile" accept="*.docx">
	<input type="file" id="dataFile" accept="*.xml">
	<ul id="datatree" class="dropfile" onclick="dataFile.click()"></ul>
	<div id="toolbar"></div>
	<div id="ruler">
		<table><tr><td>1</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td></tr></table>
	</div>
	<div id="workspace">
		<article id="empty" class="dropfile" onclick="docxFile.click()"/>
	</div>
	<dl id="styles"></dl>
	</body>	
</html>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<style>
		#editor img{clear:both;width:150px;margin:5px auto;display:block;cursor:default;border:2px solid transparent}
		#editor img:hover{border-color:blue}
		#imgTool{display:none}
	</style>
</head>
<body>
<div id="editor" style="height:400px;border:1px solid blue;padding:10px" contenteditable="true"></div>
<button type="button" onclick="editor.insertImage()">insert image</button>
<button type="button" onclick="alert(editor.getContent())">get content</button>
<button type="button" onclick="alert(editor.getThumb())">get thumb</button>

<div id="imgTool">
	<input type="file" name="_file" onchange="this.files && imgTool.editor.insertImage(this.files)" multiple>
	<canvas name="_canvas" width="1024" height="1024" style="width:1024px;height:1024px"></canvas>
	<textarea></textarea>
</div>
<script type="text/javascript">
var Editor=function(el,saver){
	if(!HTMLImageElement.prototype.isData)
	HTMLImageElement.prototype.isData=function(){
		return this.src.substr(0,4)=='data'
	}
	
	if(!HTMLImageElement.prototype.isDataJpeg)
	HTMLImageElement.prototype.isDataJpeg=function(){
		return this.src.substr(0,15)=='data:image/jpeg'
	}
	
	if(!saver){
		saver=function(img,data){
			alert(data.length)
			alert(atob(data).length)
			return data;
		}
	}
	
	var savedRange,isInFocus=false;
	function saveSelection(){
		savedRange=getSelection ? getSelection().getRangeAt(0) : document.selection.createRange()
	}

	function restoreSelection(){
		isInFocus = true;
		if (savedRange != null) {
			if (window.getSelection){//non IE and there is already a selection
				var s = window.getSelection();
				if (s.rangeCount > 0) 
					s.removeAllRanges();
				s.addRange(savedRange);
			} else if (document.selection)//IE
				savedRange.select();
		}
	}
	
	function cancelEvent(e){
		if (isInFocus == false && savedRange != null) {
			if (e && e.preventDefault) {
				e.stopPropagation(); // DOM style (return false doesn't always work in FF)
				e.preventDefault();
			}else 
				window.event.cancelBubble = true;//IE stopPropagation
			restoreSelection();
			return false; // false = IE style
		}
	}
	
	el.addEventListener('blur',function(){isInFocus=false})
	el.addEventListener('mouseup',saveSelection)
	el.addEventListener('keyup',saveSelection)
	el.addEventListener('focus',restoreSelection)
	
	el.insertImage=function(f,reader){
		if(arguments.length==0){
			imgTool.editor=this
			imgTool.querySelector('input').click()
		}else{
			var i=0,len=f.length;
			(reader = new FileReader()).onload=function(e){
				el.focus()
				restoreSelection();
				document.execCommand('insertText',false,"\n")
				document.execCommand('insertImage',true,e.target.result)
				document.execCommand('insertText',false,"\n")
				if(i<len)
					reader.readAsDataURL(f[i++]);
			}
			reader.readAsDataURL(f[i++]);
		}
	}
	el.addEventListener('click',function(e){
		if(e.srcElement.nodeName=='IMG'){
			if (window.getSelection){//non IE and there is already a selection
				var s = window.getSelection();
				if (s.rangeCount > 0) 
					s.removeAllRanges();
				var r=document.createRange();
				r.setStartBefore(e.srcElement);
				r.setEndAfter(e.srcElement);
				s.addRange(r);
			} else if (document.selection)//IE
				savedRange.select();
		}
	})
	el.getThumb=function(){
		var thumb=this.querySelector('img');
		if(!thumb || !thumb.isData())
			return null;
		return getImageData(thumb,96);
	}
	el.saveImageData=function(imageSaver){
		for(var images=this.querySelectorAll('img[src^="data:image"]'),img,len=images.length,i=0;i<len;i++){
			img=images[i]
			img.src=imageSaver(img,getImageData(img,1024));
		}
	}
	el.getContent=function(imageSaver){
		this.saveImageData(imageSaver||saver);
		return this.innerHTML;
	}

	function getImageData(image,size){
		var tool=imgTool.querySelector('canvas'),
			ctx=tool.getContext('2d'),
			img=new Image();
		img.src=image.src;
		var wh=img.width/img.height;
		tool.width = wh>=1 ? (size<img.width ? size : img.width) : (size<img.height ? Math.floor(size*wh) : img.width);
		tool.height = wh<1 ? (size<img.height ? size : img.height) : (size<img.width ? Math.floor(size/wh) : img.height);
		tool.style.width=tool.width+"px"
		tool.style.height=tool.height+"px"
		ctx.drawImage(img,0,0,img.width,img.height,0,0,tool.width, tool.height);
		return tool.toDataURL("image/jpeg")
	}
	
	return el
}

new Editor(editor)
</script>
</body>
</html>
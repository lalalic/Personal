<#macro init_comment>
</#macro>

<#macro comment_head>
	<#if comment_headed??>
		<#return>
	</#if>
	<style>
	    #comment{display:none}
	    .comments li{ border-bottom: 1px gray dotted;margin:10px auto;padding:5px 0}
	    .comments li.weibo{}
	</style>
	<script>
	    function showAComment(comment){
	        $('#comments_'+comment.entityID).append("<li>"+comment.message+" <span class='right'>-- "+comment.commenter+" on "+Date.parse(comment.created).datetimeString()+"</span></li>")
	    }  
	    
	    jQuery(function($){
	    	var entities=$('ul.resolving.comments').removeClass('resolving')
	    		.map(function(){
	    			return $(this).attr('id').split('_')[1]
	    		})
	    	if(entities.length>0){
    	    	$.get("/comment/get/"+entities.toArray().join(","),function(comments){
                    $(comments).each(function(){
                        showAComment(this)
                    })
                })    
	    	}
	    	
	    })    
	    
	    function showCommentForm(ID){
	        var $comment=$('#comment')
	        
	        
	        if($('#comments_'+ID).next().is($comment))
	           $comment.toggle('slow')
	        else{
	           $('#comments_'+ID).after($comment)
	           $comment.show("slow")
	           $comment.find("input[name=ID]").val(ID)
	        }
	    }
	    
	    <#if website.weibo.token??>
	    jQuery(function($){
	        $(".weibo.comments").each(function(){
	            var $this=$(this),
	            	wb="https://api.weibo.com/2/comments/show.json?access_token=${website.weibo.token}&id=",
	    	        weiboID=$this.attr('weiboID')
	            $.get(wb+weiboID,function(comments){
                        if(!(comments && comments.length)) 
                            return
                       for(var i=0;i<comments.length;i++){
                            var a=comments[i]
                            $this.append('<li class="weibo">'+a.text+'<span class="right">'+a.user.screen_name+' on '+a.created_at+'</span>'+'</li>')
                        }
                    })
	        })
	    })
	    </#if>
	</script>
	<#assign comment_headed=true>
</#macro>

<#macro comment model>
	<@comment_head/>
    <ul class="comments resolving <#if model.weiboID??>weibo</#if>" id="comments_${model.ID}" weiboID="${model.weiboID!}"></ul>
    <@commentForm entity=model/>
</#macro>

<#macro commentForm entity>
    <#if !(commentFormed??)>
	    <form action="/comment/add" method="post" id="comment"
	        onsubmit="return ajaxSubmit.call(this,event)"
	        onsuccess="showAComment(data);this.reset()">
	        <input type="hidden" name="ID" value="${entity.ID}">
	        <textarea name="comment" required style="width:100%;height:4em" minlength="10"></textarea>
	        <#if !user.isLoggedIn() && website.anonymousComment>            
	            <table width="100%">
	                <tr>
	                    <td><a href="/user/signin.html">Login</a>
	                    </td>
	                    <td>or</td>
	                    <td>
	                         <table>
	                             <tr><td>姓名</td><td><input name="name"></td></td></tr>
	                             <tr><td>email</td><td><input name="email"></td></td></tr>
	                             <tr><td>主页</td><td><input name="url"></td></td></tr>
	                         </table>
	                </tr>
	            </table>
	        </#if>
	        <div class="actions"><button type="submit">保存评论</button></div>
	        <#assign isEditable=true>
	        <#assign commentFormed=true>
	    </form>
    </#if>
</#macro>

<#macro commentButton entity>
	<@cmd onclick="showCommentForm.call(this,${entity.ID})" label="评论"/>
</#macro>


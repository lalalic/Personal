<#global headMacros=[] deferedMacros=[]>
<#global template=website.defaultTemplate>
<#macro dynamicMacro macros>
    <#if macros?has_content>
        <#if macros?is_string>
            <#if macros?contains(",")>
                <#local macros=macros?split(",")>
                <#list macros as macro>
                    <#-- dymamic macro (,): ${macro} -->
                    <@.main[macro]/>
                </#list>
            <#else>
                <#-- dymamic macro: ${macros} -->
                <@.main[macros]/>
            </#if>
        <#elseif macros?is_enumerable>
            <#list macros as macro>
                <#-- dymamic macro []: ${macro} -->
                <@.main[macro]/>
            </#list>
        </#if>
    </#if>
</#macro>

<#macro content>
    <#if contentMacroName??>
        <@dynamicMacro macros=contentMacroName/>
    <#else>
        you should override macro content
    </#if>
</#macro>

<#macro empty></#macro>

<#-- replace matrix parameters in request.path -->
<#function matrix name value="">
	<#local reg="(;"+name+"=)(-?\\w+)">
	<#if value=="">
		<#local path=request.path?replace(reg,"","r")>
	<#else>
		<#if (request.path?index_of(";"+name+"=")>0)>
			<#local path=request.path?replace(reg,"$1"+value,"r")>
		<#else>
			<#local path=request.path+";"+name+"="+value>
		</#if>
	</#if>
	<#return "/"+path>
</#function>

<#macro suggestInput action="/"+path+"/suggest;title*=" onsuggest="">
    <#if !(suggestInputed??)>
        <style>
            .suggest{position:absolute;display:none;min-width:150px;min-height:60px;z-index:999;background-color:white;list-style:none;line-height:25px}
            .suggest li{margin:5px;cursor:default}
            .suggest li.current{background-color:blue}
        </style>
        <script>
        	var suggestTimer
        	function doSuggestLoad(){
            	var $this=$(this),
            		value=$this.val(),
            		action=$this.attr('action')+value
            	if(value.length>1){
            		var input=$this.offset()
            		$this.next('.suggest')
	                	.css({top:input.top+25, left:30})
	                	.load(action,function(a){
	                		if(a.match(/li/g))
	                			$(this).show()
	                		else
	                			$(this).hide().empty()
	                	})
        		}
        	}
            function suggestInput(e){
            	var self=this
            	switch(e.which){
            	case 38://up
            		selectPrevSuggest.call(this)
            		return;
            	case 40://down
            		selectNextSuggest.call(this)
            		return;
            	case 13://enter
            		var current=$(this).next('ul').find('li.current'),
            			id=current.attr('id'),title=current.text()
            		$(this).next('ul').hide().empty()
            		if(0==current.length){
            			if(suggestTimer)
            				clearTimeout(suggestTimer)
            			return;
            		}else{
            			new Function("id,title",$(self).attr('onsuggest'))(id,title);
            			e.preventDefault();
            			return false;
            		}
            	default:
            	}
            	if(suggestTimer)
            		clearTimeout(suggestTimer)
            	if(this.value.length<2)
            		return;
            	
            	suggestTimer=setTimeout(function(){doSuggestLoad.call(self)}, 2000);
            }
            function suggestOnSelect(e){
                var $this=$(this), src=$(e.sourceElement)
                $this.hide().prev('input').val(src.text())
            }
            function selectPrevSuggest(){
            	var suggests=$(this).next('ul').children('li')
            	var current=suggests.filter(".current")
            	if(current.length==1){
            		var prev=current.prev('li')
            		current.removeClass('current')
            		if(prev.length==1)
            			prev.addClass('current')
            		else
            			suggests.filter(':last').addClass('current')
            	}else
            		suggests.filter(':first').addClass('current')
            }
            
            function selectNextSuggest(){
            	var suggests=$(this).next('ul').children('li')
            	var current=suggests.filter(".current")
            	if(current.length==1){
            		var next=current.next('li')
            		current.removeClass('current')
            		if(next.length==1)
            			next.addClass('current')
            		else
            			suggests.filter(':first').addClass('current')
            	}else
            		suggests.filter(':last').addClass('current')
            }
        </script>
        <#assign suggestInputed=true>
    </#if>
    <input action="${action}" onkeydown="suggestInput.call(this,event)" onkeyup="if(this.value.length==0) $(this).next('ul').hide().empty()" onsuggest="${onsuggest}" <#nested> >
    <ul class="suggest" onclick="suggestOnSelect.call(this,event)"></ul>
</#macro>

<#macro suggest>
    <#list it as m><li id="${m.ID}">${m.title!m.name}</li></#list>
</#macro>

<#macro cmd href="" onclick="" label="" needLogin=true base="">
    <#if needLogin && !user.isLoggedIn()>
        <#if href==''>
            <a <#nested> onclick="if(prompt('Need signin first','Do you want to signin and come back?')) document.location.href='/user/signin.html'" href="javascript:void(0)">${label}</a>
            <#return>
        <#elseif href?starts_with('#')>
            <a <#nested> href="/user/signin.html?targetURL=${base}${href}">${label}</a>
            <#return>
        </#if>
    </#if>
    <a <#nested> href="<#if href!=''>${base}${href}<#else>javascript:void(0)</#if>" <#if onclick!=''>onclick="${onclick}"</#if>>${label}</a>
</#macro>

<#macro ratingInputUI name="" title="" value=30>
    <#if !(ratingInputUIed??)>
	    <style>
	        .ratingInput{margin:10px 10px 10px auto;border:1px solid #bbb; border-radius:5px}
	        .star{
	            cursor:default;display:inline-block;width:25px;text-indent:-9999em;padding:2px;
	            background-image:url(/rs/images/icons.png);background-repeat:no-repeat;
	         }
	        .star-on{background-position:2px -397px}
	        .star-off{background-position:2px -428px}
	        .star-half{background-position:2px -500px}
	        .ratingShow{display:none;position:absolute;text-align:center;opacity:0.8; filter:alpha(opacity=80)}
	    </style>
	    <script>
	        function rating(){
	            var input=$(this.parentNode).find('input');
	            if(input.length==0)
	                return
	            input.val($(this).text())
	            $(this)
	                .siblings('span').removeClass('star-on star-off')
	                .end()
	                .prevAll('span').addClass('star-on')
	                .end()
	                .nextAll('span').addClass('star-off')
	            $(this).removeClass('star-off').addClass('star-on')
	        }
	        
	        function showRating(ID){
	            var offset=$(this).offset()
	            offset.left+=40;
	            offset.top-=60;
	            $('#rating'+ID).appendTo('body').css(offset).show('slow')
	        }
	        function hideRating(ID){
	            $('#rating'+ID).hide('slow')
	        }
	    </script>
	    <#assign ratingInputUIed=true>
    </#if>
    <#if value==0><#return></#if>
    <div class="left span-5">
    	<#if title?has_content>
        	<div>${title}</div>
        </#if>
        <div>
            <#if name!=""><input type="hidden" name="${name}" value="${value}"></#if>
            <#local starOn=(value/10)?floor starHalf=(value-10*starOn)/5 starOff=5-starOn-starHalf >
            <#if (starOn>0)>
            <#list 1..starOn as a>
            <span class="star star-on" onclick="rating.call(this,event)">${a*10}</span>
            </#list>
            </#if>
            
            <#if (starHalf>0)>
            <span class="star star-half">${starOn*10+5}</span>
            </#if>
            
            
            <#if (starOff>0)>
            <#list 1..starOff as a>
            <span class="star star-off" onclick="rating.call(this,event)">${starOn*10+a*10}</span>
            </#list>
            </#if>
        </div>
    </div>
</#macro>
<#macro ratingUI value>
    <#if !(ratingUIed??)>
	    <style>
	        .star{
	            cursor:default;display:inline-block;width:15px;text-indent:-9999em;padding:2px;
	            background-image:url(/rs/images/icons.png);background-repeat:no-repeat;
	         }
	        .star-on{background-position:2px -397px}
	        .star-off{background-position:2px -428px}
	        .star-half{background-position:2px -500px}
	    </style>
	    <#assign ratingUIed=true>
	</#if>
	<#if value==0>
		<span class="star star-off">0</span>
		<#return>
	</#if>
	<#local starOn=(value/10)?floor starHalf=(value-10*starOn)/5 starOff=5-starOn-starHalf >
	<#if (starOn>0)>
	<#list 1..starOn as a>
	<span class="star star-on">${a*10}</span>
	</#list>
	</#if>
	
	<#if (starHalf>0)>
	<span class="star star-half">${starOn*10+5}</span>
	</#if>
</#macro>

<#macro dateUI name="" value=.now maxYear=2012 minYear=2000 time=false placeholder="" title=false>
    <#if !(dataUIed??)>
        <script>
            function dateUIInit(name){
                var container=$("#dateUI-"+name),
                    input=container.find("input[type=hidden]"),
                    selects=container.find("select")
                    value=input.val()

                if(value){
                    var vs=value.split('-');
                    for(var i=0; i<selects.length; i++)
                        $(selects.get(i)).val(vs[i])
                }
                
                $(input.get(0).form).submit(function(){
                    var value=[]
                    selects.each(function(){
                        value.push($(this).val())
                    })
                    input.val(value.join('-'))
                })
                
            }
        </script>
        <#assign dateUIed=true>
    </#if>
	<span class="dateUI" id="dateUI-${name}">
	    ${placeholder}
	    <input type="hidden" name="${name}" value="<#if time>${(value!.now)?string('yyyy-M-d-H-m')}<#else>${(value!.now)?string('yyyy-M-d')}</#if>">
		<select><#if title><option value=0>Year</option></#if><@optionUI options=minYear..maxYear value=value?string('yyyy')/></select>
		<select><#if title><option value=0>Month</option></#if><@optionUI options=1..12 value=value?string('M')/></select>
		<select><#if title><option value=0>Day</option></#if><@optionUI options=1..31 value=value?string('d')/></select>
		<#if time>
		<select><@optionUI options=0..23 value=value?string('H')/></select>:
		<select><@optionUI options=0..59 value=value?string('m')/></select>
		</#if>
	</span>
</#macro>

<#function itemValue mode option index=0>
	<#switch mode>
		<#case "Model">
			<#return option.ID>
		<#case "ValueName">
			<#return option[0]>
		<#case "OnlyValue">
			<#return option>
		<#case "IndexName">
			<#return index>
	</#switch>
</#function>

<#function itemTitle mode option name="name">
	<#switch mode>
		<#case "Model">
			<#return option[name]>
		<#case "ValueName">
			<#return option[1]>
	</#switch>
	<#return option>
</#function>

<#function optionMode options mode="OnlyValue">
    <#if options?size==0>
        <#return "None">
    <#elseif mode!="OnlyValue">
        <#return mode>
    <#else>
        <#local aoption=options[0]>
        <#if aoption?is_enumerable>
            <#return "ValueName">
        <#elseif aoption?is_hash>
            <#return "Model">
        </#if>
    </#if>
    <#return "OnlyValue">
</#function>

<#macro checkboxUI options name values=[] chunk=0 inputType="checkbox">
	<#local mode=optionMode(options)>
	<#if (chunk>0) && (options?size>chunk)>
		<table style="width:100%">
		<#list options?chunk(chunk) as row>
			<tr>
			<#list row as option>
				<#local value=itemValue(mode, option) title=itemTitle(mode, option)>
		    	<td><input type="${inputType}" name="${name}" value="${value}" <#if values?seq_contains(value)>checked="checked"</#if> <#nested> >${title}&nbsp;</td>
	    	</#list>
	    	</tr>
	    </#list>
	    </table>
	<#else>
		<#list options as option>
			<#local value=itemValue(mode, option) title=itemTitle(mode, option)>
	    	<input type="${inputType}" name="${name}" value="${value}" <#if values?seq_contains(value)>checked="checked"</#if> <#nested> >${title}
	    </#list>
    </#if>
</#macro>

<#macro radioUI options name values=[] chunk=0>
    <@checkboxUI options name values chunk "radio"/>
</#macro>
<#macro optionUI options value="" mode="OnlyValue" name="name" prefix="" startIndex=0>
	<#local mode=optionMode(options, mode)>
	<#list options as option>
		<#local v=itemValue(mode, option, startIndex) title=itemTitle(mode, option, name)>
		<option  value="${v}" <#if value?string==v?string>selected="selected"</#if>>${prefix}${title!}</option>
		<#local startIndex=startIndex+1>
    </#list>
</#macro>

<#macro locationUI model={} latlng=false>
	<#if !(locationUIed??)>
	<style>
		.locationUIMap{margin: auto 10px;width:150px;height:150px}
	</style>
	<script>
		function updateArea(){
			$.get('/tag/children/'+$(this).val(),function(areas){
				
			})
		}
	</script>
	</#if>
	<div class="left">
	    <input name="city" type="hidden">
	    <select name="area" onchange="$(this).prev('input').val($(':selected',this).parent().attr('label'))">
	        <#list website.cityes as city>
	           <optgroup label=${city}>
	               <#local areas=website.areas[city]!>
	               <#if areas?has_content>
    	               <#list website.areas[city] as area>
    	                   <option>${area}</option>
    	               </#list>
	               </#if>
	           </optgroup>
	        </#list>
	    </select>
		<input name="address" placeholder="街道地址" value="${model.address!}">
		<input name="landmarkers" placeholder="附近地标" value="${model.landmarkers!}">
		<input type="hidden" name="latlng" value="${model.latlng!}" value="${model.latlang!}">
	</div>
	<#if latlng><div class="locationUIMap left"></div></#if>
	<#assign locationUIed=true>
</#macro>

<#macro searchableSelect name title options value>
    <select name="${name}" onchange="location.href='${matrix(name)}'+(this.selectedIndex&&(';${name}='+$(this).val())||'')">
        <option>${title!}...</option>
        <@optionUI options=options value=value/>
    </select>
</#macro>

<#macro addableList list=[] name="" nameField="">
    <#if !(addableListed??)>
    <style>.addableList{height:3em}</style>
    <#assign addableListed=true>
    </#if>
     <#compress>
    <textarea name=${name} class="addableList">
        <#list list as v><#if nameField=="">${v}<#else>${v[nameField]}</#if>&#13;</#list>
    </textarea>
    </#compress>
</#macro>

<#macro listTag cat name="" type="checkbox" value=[] multiple=true placeholder="" chunk=0>
	<#switch type>
		<#case "checkbox">
			<@checkboxUI name=name options=website.tagger.list(cat) values=value chunk=chunk/>
		<#break>
		<#case "radio">
			<@radioUI name=name options=website.tagger.list(cat) values=value chunk=chunk/>
		<#break>
		<#case "input">
			<input name="${name}" placeholder="${placeholder}" value="${website.tagger.listName(value)}">
			<ul class="suggest">
				<#list website.tagger.list(cat) as tag><li>${tag.name}</li></#list>
			</ul>
		<#break>
		<#case "option">
			<@optionUI mode="Model" options=website.tagger.list(cat) value=value/>
		<#break>
	</#switch>
</#macro>

<#macro modelTree models=[] level="">
    <#list models as model>
        <option value="${model.ID}">${level+model.name}</option>
        <#local children=model.children>
        <#if children?has_content>
            <@modelTree models=children level=level+"--"/>
        </#if>
    </#list>
</#macro>

<#macro uploader>
<#if uploadered??><#return></#if>
<script>
(function($){
	$.fn.uploader = function (options){
		var iframeID='uploadframe',
			o=$.extend({
				service:'',	
				json : true, 
				beforeSubmit: function(){
					this.action=$.ajax('/media/want2upload/media/return',{async:false}).responseText
				},
				complete : $.noop}, options)
		
		if (!$('#' + iframeID).length)
			$('<iframe/>',{id:iframeID,name:iframeID}).hide().appendTo('body')
		
		return $(this).each(function (){
			$(this).click(function(){
				$('#'+iframeID+'form').remove()
				$('<form></form>',{target:iframeID, id:iframeID+'form',method:'post',enctype:"multipart/form-data",action:o.service})
					.css({position:'absolute',top:-1000}).appendTo('body')
					.append($('<input type="file" name="file" multiple="true">').change(function(){$(this.form).submit()}))
					.submit(function (){
						if(false===o.beforeSubmit.apply(this))
							return false;
						var iframe = $('#' + iframeID).load(function (){
							var response = iframe.contents().find('body'),
								returnReponse=o.json?$.parseJSON(response.text()):response.text()
							o.complete.call(this, returnReponse)
							iframe.unbind('load')
							setTimeout(function (){response.empty()}, 1)
						})
					}).find('input[type=file]').click()
			})
		})
	}
})(jQuery);
</script>	
<#assign uploadered=true>
</#macro>

<#macro dialog>
<#if dialoged??><#return></#if>
<style>
.dialog{border:10px solid orange; border-radius:10px;background:white;padding:10px;z-index:99999}
.dialog h5{margin-top:-30px}
.closer{cursor:default;font-weight:bold}
</style>
<script>
(function($){
    
    $.fn.centerAt=function(pos){//center element at pos
        return this.each(function(){
                var $this=$(this),
                    offset=$this.css(pos).position()
                $this.css({left:Math.floor(offset.left-$this.width()/2), top:Math.floor(offset.top-$this.height()/2)})
            })  
    }
    $.fn.center=function(){//get center of an element
        var $this=$(this.get(0)),
            pos=$(this).position()
        return {left:pos.left+Math.floor($this.width()/2), top:pos.top+Math.floor($this.height()/2)}
    }
        
	$.fn.dialog=function(options){
		function Dialog(title,content,options){
			var options=$.extend({center:'body'},{onclose:$.noop},options||{}),
				header=$('<h5 class="info">'+title+' <span class="right closer">X</span></h5>'),
				dialog=$('<div class="dialog"/>').appendTo('body')
					.css({position:'absolute','min-width':400,'min-height':300,left:200,top:300})
					.append(header)
					.append($(content))
			header.find('span.closer').click(function(){
				dialog.remove()
				options.onclose()
			})
			dialog.centerAt($(options.center).center())
			return dialog
		}
		return $(this).each(function(){this.dialog=Dialog(this.title,this,options)})
	}
})(jQuery)
</script>
<#assign dialoged=true>
</#macro>

<#macro editor name content="" placeholder="">
    <textarea name="${name}" class="editor" <#nested> >${content!placeholder}</textarea>
    <#if !editored??>
    	<@dialog/>
    	<@uploader/>
    	<style>
			textarea.editor{display:none}
			.toolbar{width:100%;height:25px}
			.toolbar input{background:url('/rs/images/icons.png') no-repeat;padding-left:25px;border:0px;margin-right:20px;min-width:25px}
			.toolbar input:hover{color:blue}
			.toolbar select{float:left}
			.toolbar .createlink{background-position:2px -152px}
			.toolbar .bold{background-position:2px -364px}
			.toolbar .image{background-position:2px -57px}
			.toolbar .video{background-position:2px -28px}
			.toolbar .face{background-position:2px 0px}
			.toolbar .italic{background-position:2px -120px}
			.content{border:1px #bbb solid; padding:5px; border-radius:5px; font-size:larger;background-color:white;line-height:2em}
			.content img{width:250px;clear:both;display:block;margin:5px auto;border:3px solid greenyellow; border-radius:3px; padding:6px}
			.maxium{z-index:99998;width:90%;height:90%;position:absolute;margin:2%;padding:10px;background:black}
			.maxium .content{height:90%}
    	</style>
        <script>
			(function($){
				$.editor=function(options){
					this.options=$.extend({
							commands:["bold"]
						},options)
					var o=this.options,
						self=this,
						commands=o.commands,
						toolbar=$(o.toolbar),
						content=$(o.content).attr('contenteditable',true),
						defaultCommand={
							type:'button',
							execute: function(args,rng){
								self.document.execCommand(this.command,false,args)
							},
							onCreate:$.noop,
							fmtOption:function(){
								return $('<option>'+this.title||this.name||this+'</option>',this)
							}
						}
					this.maxium=false
					this.document=content.get(0).ownerDocument
					this.window=window
					$.each(commands,function(){
						var cmdDef=$.editor.getCommand(this),
							cmd=$.extend({},defaultCommand,cmdDef.substr&&{command:cmdDef}||cmdDef),
							name=cmd.command,
							title=cmd.title||name

						switch(cmd.type){
						case 'button':
							$('<input type="button" class="'+name+'" value="'+title+'">')
								.appendTo(toolbar)
								.click(function(){cmd.execute(self)	})
						break
						case 'select':					
							var select=$('<select/>',{title:title}).addClass(name)
								.appendTo(toolbar)
								.change(function(){cmd.execute(self,$(this).val())})
							$.each(cmd.options,function(){
								select.append(cmd.fmtOption.call(this))
							})
						break
						case 'dialog':
							$('<input type="button" class="'+name+'" value="'+title+'">')
								.appendTo(toolbar)
								.click(function(){
									self.saveRng()
									var form=$('<form method="post"/>').attr('title',title+" settings")
											.dialog({center:content,onclose:function(){self.restoreRng()}})
									form.css('min-height',form.parent().height()-30)
										
									$.each(cmd.settings,function(){
										$('<div/>')
											.append($('<div class="span-2"/>').text(this.title||this.name))
											.append($('<div class="span-6 last"/>').append($('<input/>',this)))
											.appendTo(form)
									})
									cmd.onCreate(self,form)
									form.append('<hr class="space"><div class="actions"><button type="submit">应用</button></div>')	
										.submit(function(e){
											e.preventDefault()		
											var args={}
											$.each($(this).serializeArray(),function(){args[this.name]=this.value})
											self.restoreRng()
											cmd.execute(self,args)
											form.parent().remove()
											return false
										})
								})
						break
						}
					})
				}
				$.editor.getCommand=function(name){
					for(var index in this.supported){
						var cmd=this.supported[index]
						if(name.substr && cmd.command==name)
							return cmd
						else if (cmd.command==name.command)
							return $.extend({},cmd,name);
					}
					return name
				}
				$.editor.supported=[/*native supported command doesn't need be listed*/
					{type:'button',command:'createlink',execute:function(){
						document.execCommand(this.command,false,prompt("url","http://"))
						}},
					{type:'select',command:"face", options:['p','pre','h1','h2','h3','h4','h5','h6'],
						formatOpt:function formatOpt(opt){return '<'+opt.value+'>'+opt.title+'</'+opt.value+'>'}},
					{type:'dialog',command:'image', settings:[{name:'src',title:"图片网址"},{type:'button',value:'上传',class:'editorupload'}],
						onCreate: function(editor,form){
							$('.editorupload',form).uploader({complete:function(urls){
								form.parent().remove()
								urls.substr && (urls=[urls])
								for(var i in urls)
									editor.document.execCommand('insertImage',false,urls[i])
							}})
						},
						execute: function(editor,args){
							var img=editor.findInSel('img')
							if(img)
								$(img).attr(args)	
							else if(args.src.length>0){
								editor.document.execCommand('insertImage',false,args.src)
							}
						}
					},
					{type:'button',command:'toggle',execute:function(editor){
							if(editor.maxium){
								editor.options.content.parent().removeClass('maxium').insertBefore(editor.textarea)
								editor.maxium=false
							}else{	
								editor.options.content.parent().addClass('maxium').appendTo('body')
								editor.maxium=true
							}
						}}
				]
				$.editor.prototype={
					getSel : function() {
						return (this.window.getSelection) ? this.window.getSelection() : this.document.selection;	
					},
					
					getRng : function() {
						var s = this.getSel();
						if(!s) { return null; }
						return (s.rangeCount > 0) ? s.getRangeAt(0) : s.createRange();
					},
					
					selectRng : function(rng,s) {
						if(this.window.getSelection) {
							s.removeAllRanges();
							s.addRange(rng);
						} else {
							rng.select();
						}
					},
					saveRng : function() {
						this.savedRange = this.getRng();
						this.savedSel = this.getSel();
					},
					
					restoreRng : function() {
						if(this.savedRange) {
							this.selectRng(this.savedRange,this.savedSel);
						}
					},
					selElement: function(){
						var r=this.getRng()
						if(r.startContainer) {
							var contain = r.startContainer;
							if(r.cloneContents().childNodes.length == 1) {
								for(var i=0;i<contain.childNodes.length;i++) {
									var rng = contain.childNodes[i].ownerDocument.createRange();
									rng.selectNode(contain.childNodes[i]);					
									if(r.compareBoundaryPoints(Range.START_TO_START,rng) != 1 && 
										r.compareBoundaryPoints(Range.END_TO_END,rng) != -1) {
										return contain.childNodes[i]
									}
								}
							}
							return contain
						} else {
							return (this.getSel().type == "Control") ? r.item(0) : r.parentElement()
						}
					},
					findInSel: function(selector){
						var el=$(this.selElement())
						if(el.is(selector))
							return $(el)
						var els=el.find(selector)
						if(els.length)
							return $(els.get(0))
						return null
					},
					afterpaste: function(){
						this.sanitize()
					},
					sanitize: function(){
						var content=this.options.content
						content.find('a').each(function(){$(this).before('<span>[a href="'+this.href+'"|</span>').after('<span>]</span>')})
						content.find('b').each(function(){$(this).before('<span>[b|</span>').after('<span>]</span>')})
						content.find('i').each(function(){$(this).before('<span>[i|</span>').after('<span>]</span>')})
						content.find('img').each(function(){$(this).before('<span>[img src="'+this.src+'"]</span>')})
						content.find('p,br,div,ul,ol,dt,dd').before('<span>[br]</span>')
						var v=content.html().replace(/<[^><]*\/?>/g,'')
									
						content.html(v.replace(/\[(img|br|a|b|i)[^\[\]]*\]/g,function(t,tag){
									switch(tag){
									case 'b':case 'i':case 'a':
										return t.replace('[','<').replace('|','>').replace(']','</'+tag+'>')
									break;
									case 'img':case 'br':
										return t.replace('[','<').replace(']','>')
									}
									return t;
								}).replace(/^(\s*<br>)*/,'').replace(/(<br>\s*)*$/,''))
					},
					val: function(){
						this.sanitize()
						return this.options.content.html()
					}
				}
				
				$.fn.editor=function(options){
					return $(this).each(function(){
						var $this=$(this)
						if($this.hasClass('editorResolved'))
						  return;
						var title=$this.attr('title'),
							holder=$('<div/>').insertBefore(this),
							toolbar=$('<div class="toolbar"/>').appendTo(holder),
							content=$('<div class="content"/>')
								.css({'min-width':$this.width(),'min-height':$this.height()})
								.appendTo(holder),
							editor=new $.editor($.extend({content:content,toolbar:toolbar},options))
						editor.textarea=this
						$this.removeAttr('required')
						
						var oldsubmit=this.form.onsubmit
						this.form.onsubmit=function(event){
						    oldsubmit && oldsubmit.call(this,event)
						}
						
						content.bind('paste',function(e){
							setTimeout(function(){editor.afterpaste()},0)					
						}).blur(function(e){
							$this.val(editor.val())
							$this.change()
						}).html(this.value)
						
						$(this)
						  .bind("set",function(e){content.html(this.value)})
						  .trigger('set')
						  .addClass('editorResolved')
						
					})
				}
			})(jQuery);
			
			$(function(){
				$(".editor").editor({
					commands:[
						{command:"createlink",title:"链接"},
						{command:"image",title:"图片"},
						{command:"italic",title:"引用"},
						{command:"toggle",title:"窗口"}
					]
				})
			})
        </script>
        <#assign editored=1>
    </#if>
</#macro>

<#macro required>
    <span style="color:red">*</span>
</#macro>

<#macro editableResource>
	<script>
	   function validate(){
	       //minlength
	       var els=$(":input[minlength]",this), el
	       if(els.length>0){
	           el=els.get(0)
	           var minlength=$(el).attr('minlength')
	           if(el.value.length<parseInt(minlength)){
                   alert(el.title+" must be more than "+minlength+" words.")
                   return false
               }
	       }
	       return true
	   }
        function ajaxSubmit(event){
            event.preventDefault()
            var f=this
                
            if(typeof(validate)!='undefined' 
                && $.isFunction(validate) && !validate.call(f))
                return;
            
            $.ajax({
                url: $(f).attr('action'),
                data: $(f).serialize(),
                type: $(f).attr('method')||'get',
                dataType:$(f).attr('accept')||"json",
                context: f,
                success: function(){
                    var onsuccess=$(f).attr('onsuccess')
                    onsuccess && new Function("data",onsuccess).apply(this,arguments)
                    $('#msg').empty().append($('<div class="info"/>').text("成功保存!"))
                    setTimeout(function(){$('#msg').empty()},4000)
                },
                error: function(xhr,m,ex){
                    var onerror=$(f).attr('onerror')
                    onerror && new Function("data",onerror).call(this,xhr.responseText)
                    $('#msg').empty().append($('<div class="error"/>').text(xhr.responseText))
                }
            })
            return false
        }
        function array(a){
            return $.isArray(a)&&a||[a]
        }
        function setForm(data){
           var done={},f=this
           $("input[name],select[name],textarea[name]",f).each(function(){
               if(this.name in done)
                    return;
               if(!(this.name in data))
                    return;
               var v=data[this.name]
               switch(this.tag){
               case "textara":
                    this.value=v
               break;
               case "select":
                    $(this).val(this.multiple&&array(v)||v)
               break;
               default:
                   switch(this.type){
                   case "checkbox":
                   case "radio":
                        $("input[name='"+this.name+"']",f).val(array(v))
                        break;
                   default:
                        this.value=v
                   }
               }
               done[this.name]=1
           })
       }
        function resetForm(f,url){
           $.ajax({
               url:url,
               data:$(f).serialize(),
               type:'get',
               context:f,
               success:setForm,
               dataType:'json'
           })
       }
       function remove(ctx){
           var f=this,
                elID=$("[name=ID]",f),
                ID=elID.val()
           if(ID=="0")
                return;
           $.ajax({
               url:'/'+ctx+'/remove/'+ID,
               type:'post',
               context:f,
               success:function(data){
                    $(':selected', elID).remove()
                    $(this).reset()
                    $('#msg').empty().append($('<div class="info"/>').text("删除成功!"))
               },
               dataType:'json'
           })
       }
       
       $(function(){
       	$("input.suggest").each(function(){
       		var $this=$(this)
       		$this.suggest($this.data('url'),{})
       	})
       })
	</script>	
</#macro>

<#macro slidesResource>
	<script>
	$(function(){
	    $('.slides :first-child').show('slow')
        $('.slides').click(function(){$('.slides :first-child').hide('slow').next('img').show('slow').end().appendTo('.slides')})
    });
	</script>
	<style>
        .slides {text-align:center;height:300px }
        .slides img {width:360px;display:none;margin:10px}
	</style>
</#macro>

<#if init??><@init/></#if>

<#include "/"+template+".html">

<#if isEditable!false>
    <@editableResource/>
</#if>
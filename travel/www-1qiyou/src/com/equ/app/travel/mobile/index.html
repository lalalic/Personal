<#macro want2track>
	<script>
		var trackingEl
		function init(){
			try{
				var form=document.getElementById('form')
				var conf=service.getConf()
				console.info("get configuration")
				form.whentrack.selectedIndex=conf.getInt("whentrack")
				form.whenphoto.selectedIndex=conf.getInt("whenphoto")
				
				var lasttrack=conf.getLong("vacationID")
				if(!lasttrack)
					return;
				trackingEl=document.getElementById(lasttrack+"")
				if(trackingEl==null)
					return;
				trackingEl.setAttribute('class',"tracking")
			}catch(e){
				console.error("init error:"+e.message);
			}
			console.info("initialized")
		}
		
		function track(){
			var conf=service.getConf();
			conf.set("vacationID",this.id);
			conf.set("vacationStart",new Date(this.getAttribute("data-start")).getTime())
			if(trackingEl!=null)
				trackingEl.setAttribute('class',null)
			trackingEl=this
			trackingEl.setAttribute('class',"tracking")
		}
		
		function save(){
			try{
				var conf=service.getConf()
				conf.set("whentrack",this.whentrack.selectedIndex)
				conf.set("whenphoto",this.whenphoto.selectedIndex)
				this.user.setFocus()
			}catch(e){
				console.error("save error:"+e.message);
			}
			console.info("saved")
			return false
		}
	</script>
	<style>
		ul,li{list-style:none;margin:0;padding:0}
		ul,li,button{width:100%}
		button.tracking{color:red}
	</style>
	<fieldset>
		<legend>Which Vacation you are on?</legend>
		<ul>
			<#list vacations as v>
				<li><button id="${v.ID}" onclick="track.call(this)" data-start="${v.start?date}">${v.title}</button></li>
			</#list>
		</ul>
	</fieldset>
	<form method="post" onsubmit="return save.call(this)" id="form">
		<table>
			<tr><td>When To Track</td></tr>
			<tr><td>
				<select name="whentrack">
					<option>Always</option>
					<option>Traveling</option>
					<option>Manually</option>
				</select></td></tr>
			
			<tr><td>When to Upload Photos</td></tr>
			<tr><td><select name="whenphoto">
					<option>Always</option>
					<option>Traveling</option>
					<option>Manually</option>
				</select></td></tr>
		</table>
		<center><button type="submit">Save</button></center>
	</form>
</#macro>

<#macro showList>
	<style>
	li{line-height:2em;border-bottom:1px solid gray}
	</style>
	<div class="list"><#list posts as post><a href="/plan/show/${post.ID}.shtml" onclick="return service.play('/plan/show/${post.ID}.shtml')">${post.title}</a></#list></div>
</#macro>

<#macro show1>
	<div style="opacity:0.8;background-color:lightblue">
		<h5>${post.title}</h5>
		<p>	${post.content}</p>
	</div>
</#macro>

<#macro show12>
	<div style="opacity:0.8;background-color:lightblue">
		<h4><a href="/plan/show/${post.ID}.shtml">${post.title}</a><span style="float:right"><a></a><a></a></span></h4>
		<hr/>
		<p>	${post.content}	</p>
	</div>
	<div id="map" style="width:100%;height:100%;position:absolute;z-index=-1"></div>
	<script>
	jQuery(function($){
		var database=${post.route!'null'?js_string};
   		var map=this.map=$("#map").gmap({center: "beijing"}).data("map"),
				seg={trans:TransType.drive, points:[]}, segs=[seg], 
				routeLayer=new google.maps.RouteLayer(map)
			function traverse(data){
				if(data && data.latlng && data.type==NodeType.path){
					var p=new google.maps.LatLng(data.latlng.lat, data.latlng.lng)
					!('trans' in data) && (data.trans=TransType.drive)
					if(data.trans!=seg.trans){
						if(seg.points.length==0){
							seg.trans=data.trans
							seg.points.push(p)
						}else{
							seg.points.push(p)
							seg={trans:data.trans,points:[p]}
							segs.push(seg)
						}
					}else
						seg.points.push(p)
				}
			
   			data && ('children' in data) && $.each(data.children,function(){traverse(this)})
   		}
   		traverse(database)
   		routeLayer.path(segs)
   		routeLayer.fit()
   	})
    </script>
</#macro>

<#macro head1>
	<#if contentMacroName!="show1"><#return></#if>
	<script type="text/javascript" src="/rs/jquery.min.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;libraries=places&amp;key=AIzaSyBOl4pRT3KcblUygqLwkRd1GPMOwRPApKY"></script>
	<script type="text/javascript" src="/extend/rs/equ.js"></script>
</#macro>

<#--
show1Extra: implemented
showSlaveList: [show1Slave (show1SlaveFields)]
slavePost: (slavePostFields)
-->
<#macro init>
    <#import "/com/yy/app/cms/web/base.html" as base>
    <#include "/com/yy/app/cms/web/base.html">
    <@base.init/>
    <#assign this=this+{'slave':{'model':'slave'}}>
</#macro>

<#macro show1Extra post>
	<@showSlaveList post/>
</#macro>
	<#macro slavePostForm post={}>
	   <#if !user.isLoggedIn()><#return></#if>
	   <#if !(slave??)>
	       <#assign slave={'parent':post.ID}>
	       <#local iscreate=true>
	   <#else>
	       <#local iscreate=false>
	   </#if>
	   <div class="box" <#if iscreate> id="createSlave" <#if (post.slaveCount>0)> style="display:none" </#if></#if> > 
    	   <form action="/${this.path}/slave/post" method="post"
    	   	<#if !iscreate>
    	   	onsubmit="return ajaxSubmit.call(this,event)"
    	   	onsuccess="$('#'+this.ID.value).replaceWith(data);resolveUser()"
    	   	accept="html"
    	   	</#if> >
                <h4><#if !iscreate>修改<#else>创建</#if>${this.slave.model}</h4>
                <@slavePostFields slave/>
                <div class="actions">
                    <button type="submit">保存</button> 
                    <#if iscreate>
                        <button type="button" onclick="$('#createSlave').toggle('slow')">取消</button>
                    <#else>
                        <button type="button" onclick="$('#${slave.ID}').find('>div:last').remove().end().children().show()">取消</button>
                    </#if>
                </div>
            </form>
        </div>
        <#if iscreate>
            <script>jQuery(function($){if(document.location.href.match(/#createSlave/gi)) $('#createSlave').show()})</script>
        </#if>
	</#macro>
	
	
	<#macro action1Primary post>
		<li>
		    <@cmd base='/${this.path}/show/${post.ID}.shtml' href="#createSlave" onclick="$('#createSlave').toggle('slow')" label='+${this.slave.model}'/>
	    </li>
	</#macro>
	
	<#macro showSlaveList post>
		<#local slaves=post.slaves!>
        <#local count=post.filteredSlaveCount>
		<div class="box clear">
           <span><strong>${count}个${this.slave.model}</strong></span>
			<ul class="tabs right" id="search">
				<#assign searchFilter=post.slaveFilter>
	            <@filter4SlaveList post/> 
	        </ul>
        </div>
        <#if slaves?has_content>
	   		<#list slaves as slave>
	   			<@show1Slave slave/>
	   		</#list>
           	<#if (count>slaves?size)><button onclic="more">more...</button></#if>
        </#if>
	</#macro>
	
	<#macro show1Slave slave=slave>
		<div class="post clear clearfix" id="${slave.ID}">
		    <div>
               <div class="span-1">
                   <@vote post=slave baseURI=this.path+"/slave"/>
               </div>
               <div class="span-17 last">
                   <div><@show1SlaveFields slave/></div>
                   <div class="clear clearfix">
                   		<div class="span-1">
                           &nbsp;
                       </div>
                       <div class="span-16 last">    
                           <@comment model=slave/>
                       </div>               
                   </div>
               </div>
           </div>
           <div><@showSlaveExtra slave/></div>
       </div>
       <hr class="space"/>
	</#macro>
	
	<#macro showSlaveExtra slave>
	   <#if !showSlavExtraed??>
	       <script>
	       function modify(id){
	            var root="${this.path}",
	               url='/'+root+'/edit/slave/'+id+'.shtml',
	               c=$('#'+id+'')
	            c.children().hide()
	            $('<div></div>').appendTo(c).load(url)
	       }
	       </script>
	       <#assign showSlaveExtraed=true>
	   </#if>
        <ul class="actions right">
        	<#if slave.author=user.ID>
        		<li>
        			<@cmd onclick='modify(${slave.ID})' label="修改"/>
        		</li>
        	</#if>
        	<li><@commentButton slave/></li>
    	</ul>
	</#macro>
	
	<#macro filter4SlaveList post>
		<@base.filter4List>
			<#nested post>
		</@base.filter4List>
	</#macro>
	
	<#macro listTitle>
	    <#if it!?has_content>
	        <#list it as post><li><a href="/${this.path}/show/${post.ID}.shtml">${post.title}</a></li></#list>
	    <#else>
	       没有哦!
	    </#if>
	</#macro>
	
    <#macro show14List post>
    	<#if !(show14Listed??)>
    		<tr><td>名称</td><#if post.ratable><td>点评</td></#if><td>${this.slave.model}</td><td>在本站</td></tr>
    		<#assign show14Listed=true>
    	</#if>
        <tr class="post1 clear" id="${post.ID}">
            <td><a href="/${this.path}/show/${post.ID}.shtml">${post.title!}</a></td>
           	<#if post.ratable><td><@ratingUI post.generalRating/></td></#if>
           	<td>${post.slaveCount}</td>
           	<td>
           		<#local baseURI=this.path>
           		<ul class="actions">
           			<@action1Primary post/>
                        <li>
                            <@cmd onclick='$(this).next().load(\'/${baseURI}/like/${post.ID}\')' label="喜欢">title="I like it(click again to undo)"</@cmd>
                            <span>${post.votes}</span>
                        </li>
                        <li>
                            <@cmd onclick='$(this).next().load(\'/${baseURI}/favorite/${post.ID}\')' label="收藏">title="This is my favorite(click again to undo)"</@cmd>
                            <span>${post.favorites}</span>
                        </li>
           		</ul>
           		
           		
           	</td>
        </tr>	
    </#macro>

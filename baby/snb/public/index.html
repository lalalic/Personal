<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Super Nai Ba</title>
	<link rel="stylesheet" href="res/lungo.css">
	<link rel="stylesheet" href="res/lungo.icon.css">
	<link rel="stylesheet" href="res/lungo.theme.css">
	<style>
		#show img{margin-left: auto;margin-right:auto;display:block}
		[contenteditable=true]{background-color:white;height:100%;padding:10px}
		.outview{position:absolute;top:-9999px;height:1px}
		nav img{width:32px;height:32px}
		.editor{-webkit-user-select:text;-moz-user-select:text;user-select:text;overflow-y: auto}
		#taskOption{z-index:99;position:absolute;bottom:46px;right:0px;background:white;color:black;list-style:none;padding:5px; line-height:3em;cursor:default}
		.favorited, .tasked{color:yellow}
		.stat{position:relative;height:300px;background-color:black}
		.doing{-webkit-animation:rotatingLoader 600ms infinite linear;moz-animation:rotatingLoader 600ms infinite linear}
	</style>
	<script src="res/quo.debug.js"></script>
	<script src="res/mustache.js"></script>
	<script src="res/parse-1.2.8.min.js"></script>
	<script>
		window.$=$$
		window.runtime={}
		empty=new Function()
		article=function(){return Lungo.Element.Cache.article[0]}
		form=function(){return $(article(),'form')[0]}
		Parse.initialize("CxZhTKQklDOhDasWX9hidldoK7xtzEmtcl5VSBeL","RwqvvbakVmWPhtO78QCUppfnclzfZ2SyUZ198ArG")
		HTMLSelectElement.prototype.value=function(v){
			var me=this
			if(v==undefined)
				return this.options[this.selectedIndex].value
			this.options.each(function(i,o){v==o.value && (me.selectedIndex=i)})
		}
		HTMLSelectElement.prototype.text=function(){return this.options[this.selectedIndex].text}
		HTMLFormElement.prototype.get=function(){
			var o=Parse.object(this.name)
			$(this,'[name]').each(function(){o.set(this.name,this.value||this.value())})
			return o
		}
		$.fn.once=function(e,cb,a,b){a=this,b=function(){cb.apply(this,arguments);a.unbind(e,b)};a.bind(e,b)}
		Parse.object=function(f){
			var a=new Parse.Object(f);
			for(var i=1,as=arguments,len=as.length;i<as.length;i+=2)
				a.set(as[i],as[i+1])
			return a
		}
		$.each(['find','first'],function(index,n){
			Parse[n]=function(a){
				doing()
				var f=new Parse.Query(Parse.Object.extend(a)).ascending('createdAt'),h,t,
					as=arguments,len=as.length
				if(len==1) 
					return f[n]()
				if(typeof(t=h=as[len-1])=='function')
					len--
				else if('nodeName' in h && 'SCRIPT'==h.nodeName){
					h.clean()
					h=function(o){t.build({loop:o});done()}
				}else
					h=null
				for(var i=1;i<len;i+=2)
					f.equalTo(arguments[i],arguments[i+1])
				f=f[n]()
				return h&&f.then(h,Parse.error)||f
			}
		})
		Parse.get=function(t,id){doing();return (new Parse.Query(Parse.Object.extend(t))).get(id)}
		Parse.error=function(e){done();Lungo.Notification.error("Warn", e, 'cancel', 4)}
		Parse.user=function(){return Parse.User.current()}
		setTitle=function(t){$('section.show header h1').text(t)}
		doing=function(){$('section.show [data-icon="refresh"]').addClass('doing')}
		done=function(){$('.doing').removeClass('doing')}
		Parse.Object.prototype.ago=function(){
			var delta=parseInt((new Date().getTime()-this.createdAt.getTime())/1000),
				aday=24*60*60
			if(delta<aday){
				if(delta<60)
					return delta+'秒前'
				else if(delta<60*60)
					return parseInt(delta/60)+'分前'
				else
					return parseInt(delta/60/60)+"小时前"
			}else if (delta<aday*2)
				return '昨天'
			else if (delta<aday*3)
				return '前天'
			else
				return this.createdAt.getMonth()+1+"-"+this.createdAt.getDay()+1;
				
		}
	</script>
</head>
<body>
	<section id="home" data-transition="slide">
		<header data-title="SNB">
			<nav>
				<a href="#" class="on-left" data-icon="home"></a>
				<a data-icon="refresh" class="on-right"></a>
				<a href="#" class="on-right" data-icon="user" data-view-menu="users"></a>
			</nav>
		</header>
		<nav data-control="menu" id="users" class="icons">
			<a href="#" data-icon="signout" onclick="signout()"></a>
			<a href="#" data-icon="plus-sign" data-view-section="child"></a>
			<script type="text/tmpl" id="tmplChildren">
				{{#loop}}
				<a href="#" data-icon="user" data-view-section="child" onmouseup="runtime.child={id:'{{id}}'}"><img src="{{attributes.photo._url}}"></a>
				{{/loop}}
			</script>
		</nav>
		<article id="categories" class="list scroll indented" data-on-load="Parse.find('tag','category','category',tmplCate)">
			<ul>
				<li>
					<div class="stat"></div>
				</li>			
				<script type="text/tmpl" id="tmplCate">
				{{#loop}}
				<li class="thumb">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="category" onmouseup="runtime.cat={name:'{{attributes.name}}',id:'{{id}}'}" href="#">{{attributes.name}}</a></strong>
						<small>{{attributes.desc}}</small>
						<a class="on-right" data-view-section="creator" 
							onmouseup="runtime.cat={name:'{{attributes.name}}',id:'{{id}}'}" 
							style="font-family:lungojsicon;cursor:pointer">&#xf067;</a>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a href="#" data-icon="share"></a>
				<a href="#" data-icon="star" data-view-section="favorite"></a>
				<a href="#" data-icon="list" data-view-section="task"></a>
			</nav>
		</footer>
		<script>
		function checkLogin(){
			if(!Parse.user())
				return setTimeout(function(){Lungo.Router.section('user')},1000)
			Parse.find('child','parent',Parse.user().id,
				function(o){
					o && tmplChildren.build({loop:o}) && !runtime.child && (runtime.child=o[0])
				})
		}
		</script>
	</section>
	<section id="category" data-transition="slide">
		<header data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="posts" class="list scroll" data-on-load="Parse.find('post','category',runtime.cat.name,tmplPosts)">
			<ul>
				<li>
					<div style="position:relative;height:300px;background-color:black"></div>
				</li>
				<script type="text/tmpl" id="tmplPosts">
				{{#loop}}
				<li class="thumb">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{id}}'}" href="#">{{attributes.title}}</a></strong>
						<a href="#" data-icon="comment" class="on-right" data-count="{{attributes.comments}}"></a>
						<a href="#" data-icon="star" class="on-right" data-count="{{attributes.comments}}"></a>
						<a href="#" data-icon="list" class="on-right" data-count="{{attributes.comments}}"></a>
					</div>
					
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a data-icon="plus" data-view-section="creator"></a>
				<a data-icon="share" data-view-section="creator"></a>
			</nav>
		</footer>
	</section>
	<section id="post" data-transition="slide">
		<header data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="show" class="scroll" data-on-load="taskReady();Parse.get('post',runtime.post.id).then(showPost,Parse.error)">
			<div style="padding:5px">
				<script type="text/tmpl" id="tmplPost">
					<div>
						<strong>{{attributes.title}}<span class="on-right"><a data-icon="user">{{attributes.authorName}}</a><span>{{age}}</span></span></strong>
						<p>{{{attributes.content}}}</p>
						<ul class="list" id="stories"/>
					</div>
				</script>
				<script type="text/tmpl" id="tmplStory" data-target="#stories">
					{{#loop}}
					<li class="thumb">
						<img src="{{attributes.thumbnail._url}}">
						<p>{{{attributes.content}}}</p>
					</li>
					{{/loop}}
					{{^loop}}
					<li>
						create first story!
					</li>
					{{/loop}}
				</script>
			</div>
		</article>
		<footer>
			<nav>
				<a data-icon="comment" data-view-section="comment" href="#"></a>
				<a data-icon="film" data-view-section="story" href="#"></a>
				<a data-icon="share" data-view-section="comment" href="#"></a>
				<a data-icon="star" id="cmdfavorite" onclick="doFavorite(this)" href="#"></a>
				<a data-icon="menu" id="cmdtask" onclick="onTask(event)" href="#"></a>
			</nav>
		</footer>
		<ul id="taskOption">
			<li><input type="radio" name="taskOption" value="1">Today</li>	
			<li><input type="radio" name="taskOption" value="2">Tomorrow</li>
			<li><input type="radio" name="taskOption" value="3">This week</li>
			<li><input type="radio" name="taskOption" value="4">This month</li>
			<li><input type="radio" name="taskOption" value="5">This year</li>
			<li><input type="radio" name="taskOption" value="0">Remove</li>
		</ul>
		<script>
			function showPost(p){
				tmplPost.build(runtime.post=p)
				_task(function(t){
					if(t!=null && t.get('status')){
						$(cmdtask).addClass('tasked')
						$('#taskOption [value="'+t.get('type')+'"]')[0].checked=true
					}else
						$(cmdtask).removeClass('tasked')
				})
				_favorite(function(t){
					if(t!=null && t.get('status'))
						$(cmdfavorite).addClass('favorited')
					else
						$(cmdfavorite).removeClass('favorited')
				})
				Parse.find('story','post',p.id,tmplStory)
			}
			function onTask(e){
				$(taskOption).show()
				e.cancelBubble = true
				e.stopPropagation && e.stopPropagation()
				$(document).once('click',function(){$(taskOption).hide()})
			}
			function _favorite(f){
				Parse.first('favorite','author',Parse.user().id,'post',runtime.post.id,f)
			}
			function _task(f){
				Parse.first('task','author',Parse.user().id,'post',runtime.post.id,'status',1,f)
			}
			function doFavorite(el){
				_favorite(function(f){
					if(f==null){
						f=Parse.object('favorite')
						f.set('post',runtime.post.id)
						f.set('title',runtime.post.get('title'))
						f.set('thumbnail',runtime.post.get('thumbnail'))
						f.set('status',1)
					}else if(f.get('status')==0)
						f.set('status',1)
					else
						f.set('status',0)
					f.save().then(function(){$(el)[f.get('status')?'addClass':'removeClass']('favorited')},Parse.error)
					done()
				})
			}
			function taskReady(){
				$(taskOption).hide()
				$('#taskOption input').on('click',function(){
					var me=this
					_task(function(t){
						if(me.value=='0'){
							if(t!=null){
								t.destroy()
								$(cmdtask).removeClass('tasked')
								return
							}
						}else if(t==null){
							t=Parse.object('task')
							t.set('post',runtime.post.id)
							t.set('title',runtime.post.get('title'))
							t.set('thumbnail',runtime.post.get('thumbnail'))
							t.set('status',1)
						}
						t.set('type',parseInt(me.value))
						t.save().then(function(){$(cmdtask).addClass('tasked')})
						done()
					})
				})
				taskReady=empty
			}
			
		</script>
	</section>
	<section id="favorite" data-transition="slide">
		<header data-title="Favorite" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="favorite1" class="list scroll" data-on-load="Parse.find('favorite','author',Parse.user().id,tmplFavorite)">
			<ul>
				<script type="text/tmpl" id="tmplFavorite">
				{{#loop}}
				<li class="thumb arrow">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{post}}'}" href="#">{{attributes.title}}</a></strong>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
	</section>
	<section id="task" data-transition="slide">
		<header data-title="Task" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="task1" class="list scroll" data-on-load="Parse.find('favorite','author',Parse.user().id,tmplTask)">
			<ul>
				<script type="text/tmpl" id="tmplTask">
				{{#loop}}
				<li class="thumb arrow">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{post}}'}" href="#">{{attributes.title}}</a></strong>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
	</section>
	<section id="comment" data-transition="slide">
		<header data-title="Comment" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article class="list scroll" id="showComments" data-on-load="Parse.find('comment','post',runtime.post,tmplComment); commentContent.focus()">
			<ul>
				<script type="text/tmpl" id="tmplComment">
				{{#loop}}
					<li class="thumb">
						<a href="#" data-icon="user"><br>{{attributes.authorName}}</a>
						<div>
							<p>{{{attributes.content}}}</p>
							<span class="on-right">{{ago}}</span>
						</div>
					</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a><textarea style="height:46px;padding:5px;width:100%" id="commentContent"></textarea></a>
				<button data-icon="save" onclick="saveComment()"></button>
			</nav>
		</footer>
		<script>
		function saveComment(){
			doing()
			Parse.object('comment',"content",commentContent.value,"post", runtime.post)
				.save().then(function(c){
					tmplComment.build({loop:[c]})
					commentContent.value=""
					done()
				},Parse.error)
		}
		</script>
	</section>
	
	<section id="creator" data-transition="slide">
		<header data-title="Create Post" data-back="left-sign">
			<nav>
				<button class="on-right" type="submit" form="creatForm" data-icon="save"></button>
			</nav>
		</header>
		<article id="createPost"
			data-on-load="setTimeout(function(){$('#creator header h1').text('Create '+runtime.cat.name)},300)">
			<form id="creatForm" onsubmit="savePost();return false">
				<fieldset><input type="text" placeholder="title" name="title"></fieldset>
				<fieldset><textarea name="content" class="editor" contenteditable="true">content</textarea></fieldset>
				<fieldset>
					<div>
						<input type="checkbox" name="gender" value="N5zSTzoczQ" checked="checked">Boy
						<input type="checkbox" name="gender" value="DJIUvgiFpk">Girl
					</div>
					<div>
						<select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
					</div>
				</fieldset>
				<input type="submit" class="outview">
			</form>
		</article>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick="insertImage()"></a>
				<a data-icon="trash" onclick=""></a>
			</nav>
		</footer>
		<script>
		function savePost(){
			doing()
			var newPost=Parse.object('post'),
				p=form()
			newPost.set("content",p.content.value)
			newPost.set("title",p.title.value)
			newPost.set("category",runtime.cat.name)
			newPost.set("duration", parseInt(p.duration.text()))
			newPost.addUnique("tags", p.duration.value())
			newPost.addUnique("tags",runtime.cat.id)
			p.gender.each(function(i,a){a.checked && newPost.addUnique("tags",a.value)})
			newPost.save().then(function(){Lungo.Router.back();done()})
		}
		</script>		
	</section>
	<section id="story" data-transition="slide">
		<header data-back="left-sign" data-title="Create Story">
			<nav>
				<button class="on-right" type="submit" form="storyForm" data-icon="save"></button>
			</nav>
		</header>
		<article id="createStory">
			<form id="storyForm" onsubmit="saveStory();return false">
				<fieldset><select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
				</fieldset>
				<fieldset><textarea placeholder="content" name="content"></textarea></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick=""></a>
				<a data-icon="minus" onclick=""></a>
			</nav>
		</footer>	
		<script>
		function saveStory(){
			var newStory=Parse.object('story')
			newStory.set("content",postContent.value)
			newStory.set("post",runtime.post.id)
			newStory.set("duration", parseInt(p.duration.text()))
			newStory.save().then(Lungo.Router.back)
		}
		</script>		
	</section>	
	
	<section id="user" data-transition="slide">
		<header data-back="left-sign" data-title="User Account"></header>
		<nav data-control="groupbar">
			<a href="#" data-view-article="signin" data-title="Sign In">Sign In</a>
			<a href="#" data-view-article="signup" data-title="Sign up">Sign Up</a>
			<a href="#" data-view-article="resetpassword" data-title="Reset Password">Reset Password</a>
			<a href="#" data-view-article="forgetpassword" data-title="Forget Password">Forget Password</a>
		</nav>
		<article id="signin">
			<form onsubmit="signin();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="password" type="password" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="signup">
			<form onsubmit="signup();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="email" type="email" placeholder="email where reset password will be sent"></fieldset>
				<fieldset><input name="password" type="text" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="resetpassword">
			<form onsubmit="resetpassword();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="password" type="password" placeholder="old password"></fieldset>
				<fieldset><input name="password" type="password" placeholder="new password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="forgetpassword">
			<form onsubmit="forgetpassword();return false">
				<fieldset><input name="email" type="text" placeholder="email where new password would send"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>			
		<footer>
			<nav>
				<a data-icon="ok-sign" onclick="form().submit()"></a>
			</nav>	
		</footer>
		<script>
		function signin(){
			var user=form()
			Parse.User.logIn(user.name.value, user.password.value,{
				success:Lungo.Router.back, 
				error: Parse.error
			})
			return false
		}
		
		function signup(){
			var userForm=form()
			var user=new Parse.User()
			user.setUsername(userForm.name.value)
			user.setPassword(userForm.password.value)
			user.setEmail(userForm.email.value)
			
			user.signUp(null,{
				success: Lungo.Router.back(),
				error: Parse.error
			})
			return false
		}
		
		function signout(){
			Parse.User.logOut()
			location.reload()
		}
		</script>
	</section>
	<section id="child" data-transition="slide">
		<header data-back="left-sign" data-title="Add baby"></header>
		<article id="child1">
			<form id="childForm" onsubmit="extractChild().save().then(Lungo.Router.back,Parse.error);return false">
				<input type="hidden" name="id">
				<fieldset><input type="text" name="name" placeholder="baby name"></fieldset>
				<fieldset>
					<select name="gender">
						<option value=0>Boy</option>
						<option value=1>Girl</option>
					</select>
				</fieldset>
				<fieldset><input type="date" name="birthday" placeholder="birthday"></fieldset>
				<fieldset>
					<img name="photo" onclick="uploader.bind(this).click()" 
						style="width:150px;height:150px;border:1px solid;background-color:lightgray;display:block;margin:0px auto" 
						placeholder="photo"/>
				</fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="certificate" onclick="runtime.child=extracChild()"></a>
				<button type="submit" form="childForm" data-icon="ok-sign"></button>
			</nav>
		</footer>
		<script>
		function extractChild(){
			var child=Parse.object('child'),
				f=form()
			child.set("name",f.name.value)
			child.set("gender",f.gender.value())
			child.set("birthday", f.birthday.value)
			child.set("photo", f.photo.value)
			child.set("parent", Parse.user().id)
			child.id=f.id.value
			return child
		}
		function loadChild(id){
			Parse.get(id).then(
				function(p,f){
					f=form()
					f.name.value=p.get('name')
					f.gender.value(p.get('gender'))
					f.birthday.value=p.get('birthday')
					(f.photo.value=p.getFile('photo')) && (f.photo.src=f.photo.value.url())
					f.id.value=p.id	
					done()
				},Parse.error)
		}
		</script>
	</section>
	<script src="res/lungo.debug.js"></script>		
	<script>	
		$("script[type*=tmpl]").each(function(i,tmpl,b,e){
			this.compiled=Mustache.compile((b=this.innerHTML))
			Mustache.compilePartial(this.id,b)
			this.innerHTML=""
			this.build=function(a,container){
				var el=$($.fragment(this.compiled(a))
					.filter(function(el){return el.nodeType!=3}))
					.addClass('tmpled')
				$(container||$(this).data('target')||this.parentNode).append(el)
				Lungo.Boot.Data.init(el)
			}
			this.clean=function(container){
				$(container||$(this).data('target')||this.parentNode,'.tmpled').remove()
			}
		})
		
		$("a[data-icon='refresh']").each(function(i,a){
			$(a).on('click',function(){$(article()).trigger('load')})
		})
		
		$.each(["load","unload"],function(index,e){//support data-on-(un)load	
			$("[data-on-"+e+"]").each(function(i,el){
				(el=$(this)).on(e,new Function('e,a,b,c',el.data('on-'+e)))
			})
		})
		Lungo.init({
			name:"SNB",
			history:false
		})
		
		checkLogin()
	</script>
	<input type="file" id="uploader" class="outview" onchange="this.save()">
	<script>
		uploader.bind=function(a,opt){
			this.holder=a
			a.opt=opt
			return this			
		}
		uploader.save=function(){
			doing()
			var file=new Parse.File(this.files[0].name,this.files[0]),
				holder=this.holder
			file.save(holder.opt||{
				success: function(f){
					holder.src=f.url()
					holder.file=holder.value=f
					done()
				},
				error: Parse.error
			})
		}
	</script>
 </body>
</html>

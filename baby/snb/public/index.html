<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Super Nai Ba</title>
	<link rel="stylesheet" href="res/lungo.css">
	<link rel="stylesheet" href="res/lungo.icon.css">
	<link rel="stylesheet" href="res/lungo.theme.css">
	<style>
		#show img{margin-left: auto;margin-right:auto;display:block}
		[contenteditable=true]{background-color:white;height:100%;padding:10px}
		.outview{position:absolute;top:-9999px;height:1px}
		nav img{width:32px;height:32px}
		.editor{-webkit-user-select:text;-moz-user-select:text;user-select:text;overflow-y: auto}
		#taskOption{z-index:99;position:absolute;bottom:46px;right:0px;background:white;color:black;list-style:none;padding:5px; line-height:3em;cursor:default}
		.favorited, .tasked{color:yellow}
		.stat{position:relative;height:300px;background-color:black}
		.doing{-webkit-animation:rotatingLoader 600ms infinite linear;moz-animation:rotatingLoader 600ms infinite linear}
	</style>
	<script src="res/quo.debug.js"></script>
	<script src="res/mustache.js"></script>
	<script src="res/parse-1.2.8.min.js"></script>
	<script>
		window.$=$$
		window.runtime={}
		empty=new Function()
		article=function(){return Lungo.Element.Cache.article[0]}
		form=function(){return $(article(),'form')[0]}
		Parse.initialize("CxZhTKQklDOhDasWX9hidldoK7xtzEmtcl5VSBeL","RwqvvbakVmWPhtO78QCUppfnclzfZ2SyUZ198ArG")
		HTMLSelectElement.prototype.value=function(v){
			var me=this
			if(v==undefined)
				return this.options[this.selectedIndex].value
			this.options.each(function(i,o){v==o.value && (me.selectedIndex=i)})
		}
		HTMLSelectElement.prototype.text=function(){return this.options[this.selectedIndex].text}
		HTMLFormElement.prototype.object=function(o){
			o=typeof(o)=='string'?Parse.object(o):o,
			$(this,':not([type=checkbox]):not([type=radio])[name]').each(function(i,el){el.name=='id'?(o.id=el.value):o.set(el.name,typeof(el.value)=='function'&&el.value()||el.value)})
			$(this,'[type=radio][name]:checked').each(function(i,el){o.set(el.name,el.value)})
			$(this,'[type=checkbox][name]:checked').each(function(i,el){o.addUnique(el.name,el.value)})
			for(var i=1,as=arguments,len=as.length;i<as.length;i+=2)
				a.set(as[i],as[i+1])
			return o
		}
		HTMLFormElement.prototype.set=function(o){
			$(this,':not([type=checkbox]):not([type=radio])[name]').each(function(i,el){el.name=='id'?(el.value=o.id) : o.has(el.name)&&typeof(el.value)=='function'&&el.value(o.get(el.name))||(el.value=o.get(el.name))})
		}
		$.fn.once=function(e,cb,a,b){a=this,b=function(){cb.apply(this,arguments);a.unbind(e,b)};a.bind(e,b)}
		Parse.object=function(f){
			var a=new Parse.Object(f);
			for(var i=1,as=arguments,len=as.length;i<as.length;i+=2)
				a.set(as[i],as[i+1])
			return a
		}
		$.each(['find','first'],function(index,n){
			Parse[n]=function(a){
				doing()
				var f=new Parse.Query(Parse.Object.extend(a)).ascending('createdAt'),h,t,
					as=arguments,len=as.length
				if(len==1) 
					return f[n]()
				if(typeof(t=h=as[len-1])=='function')
					len--
				else if('nodeName' in h && 'SCRIPT'==h.nodeName){
					h.clean()
					h=function(o){t.build({loop:o});done()}
				}else
					h=null
				for(var i=1;i<len;i+=2)
					f.equalTo(arguments[i],arguments[i+1])
				f=f[n]()
				return h&&f.then(h,Parse.error)||f
			}
		})
		Parse.get=function(t,id){doing();return (new Parse.Query(Parse.Object.extend(t))).get(id)}
		Parse.error=function(e){done();Lungo.Notification.error("Warn", e, 'cancel', 4)}
		Parse.user=function(){return Parse.User.current()}
		setTitle=function(t){setTimeout(function(){$('section.show>header h1').text(t)},300)}
		doing=function(){$('section.show [data-icon="refresh"]').addClass('doing')}
		done=function(){$('.doing').removeClass('doing')}
		Parse.Object.prototype.ago=function(){
			var delta=parseInt((new Date().getTime()-this.createdAt.getTime())/1000),
				aday=24*60*60
			if(delta<aday){
				if(delta<60)
					return delta+'秒前'
				else if(delta<60*60)
					return parseInt(delta/60)+'分前'
				else
					return parseInt(delta/60/60)+"小时前"
			}else if (delta<aday*2)
				return '昨天'
			else if (delta<aday*3)
				return '前天'
			else
				return this.createdAt.getMonth()+1+"-"+this.createdAt.getDay()+1;
				
		}
	</script>
</head>
<body>
	<section id="home" data-transition="slide">
		<header data-title="SNB">
			<nav>
				<a href="#" class="on-left" data-icon="home"></a>
				<a data-icon="refresh" class="on-right"></a>
				<a href="#" class="on-right" data-icon="user" data-view-menu="users"></a>
			</nav>
		</header>
		<nav data-control="menu" id="users" class="icons">
			<a href="#" data-icon="signout" onclick="Parse.User.logOut();location.reload()"></a>
			<a href="#" data-icon="plus-sign" data-view-section="child"></a>
			<script type="text/tmpl" id="tmplChildren">
				{{#loop}}
				<a href="#" data-icon="user" data-view-section="child" onmouseup="runtime.child={id:'{{id}}'}"><img src="{{attributes.photo._url}}"></a>
				{{/loop}}
			</script>
		</nav>
		<article id="categories" class="list scroll indented" data-on-load="Parse.find('tag','category','category',tmplCate)">
			<ul>
				<li>
					<div class="stat"></div>
				</li>			
				<script type="text/tmpl" id="tmplCate">
				{{#loop}}
				<li class="thumb">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="category" onmouseup="runtime.cat={name:'{{attributes.name}}',id:'{{id}}'}" href="#">{{attributes.name}}</a></strong>
						<small>{{attributes.desc}}</small>
						<a class="on-right" data-view-section="creator" 
							onmouseup="runtime.cat={name:'{{attributes.name}}',id:'{{id}}'}" 
							style="font-family:lungojsicon;cursor:pointer">&#xf067;</a>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a href="#" data-icon="share"></a>
				<a href="#" data-icon="star" data-view-section="favorite"></a>
				<a href="#" data-icon="list" data-view-section="task"></a>
			</nav>
		</footer>
		<script>
		function checkLogin(){
			if(!Parse.user())
				return setTimeout(function(){Lungo.Router.section('user')},1000)
			Parse.find('child','parent',Parse.user().id,function(o){
					o && tmplChildren.build({loop:o}) && !runtime.child && (runtime.child=o[0])
				})
		}
		</script>
	</section>
	<section id="category" data-transition="slide">
		<header data-back="left-sign" data-title="Posts In Category">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="posts" class="list scroll" data-on-load="setTitle(runtime.cat.name);Parse.find('post','category',runtime.cat.name,tmplPosts)">
			<ul>
				<li>
					<div style="position:relative;height:300px;background-color:black"></div>
				</li>
				<script type="text/tmpl" id="tmplPosts">
				{{#loop}}
				<li class="thumb">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{id}}'}" href="#">{{attributes.title}}</a></strong>
						<a href="#" data-icon="comment" class="on-right" data-count="{{attributes.comments}}"></a>
						<a href="#" data-icon="star" class="on-right" data-count="{{attributes.comments}}"></a>
						<a href="#" data-icon="list" class="on-right" data-count="{{attributes.comments}}"></a>
					</div>
					
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a data-icon="plus" data-view-section="creator"></a>
				<a data-icon="share" data-view-section="creator"></a>
			</nav>
		</footer>
	</section>
	<section id="post" data-transition="slide">
		<header data-back="left-sign" data-title="loading">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="show" class="scroll" data-on-load="$(taskOption).hide();Parse.get('post',runtime.post.id).then(showPost,Parse.error)">
			<div style="padding:5px">
				<script type="text/tmpl" id="tmplPost">
					<div>
						<div style="min-height:50%">
							<div><span class="on-right"><a data-icon="user">{{attributes.authorName}}</a><span>{{age}}</span></span></div>
							<p>{{{attributes.content}}}</p>
						</div>
						<ul class="list" id="stories"/>
					</div>
				</script>
				<script type="text/tmpl" id="tmplStory" data-target="#stories">
					{{#loop}}
					<li class="thumb">
						<img src="{{attributes.thumbnail._url}}">
						<p>{{{attributes.content}}}</p>
					</li>
					{{/loop}}
					{{^loop}}
					<li class="empty">
						create first story!
					</li>
					{{/loop}}
				</script>
			</div>
		</article>
		<footer>
			<nav>
				<a data-icon="comment" data-view-section="comment" href="#"></a>
				<a data-icon="film" data-view-section="story" href="#"></a>
				<a data-icon="share" data-view-section="comment" href="#"></a>
				<a data-icon="star" id="cmdfavorite" onclick="toggleFavorite()" href="#"></a>
				<a data-icon="menu" id="cmdtask" onclick="showTaskOption(event)" href="#"></a>
			</nav>
		</footer>
		<ul id="taskOption">
			<li><input type="radio" name="taskOption" value=1 onclick="addTask(event,1)">Today</li>	
			<li><input type="radio" name="taskOption" value=2 onclick="addTask(event,2)">Tomorrow</li>
			<li><input type="radio" name="taskOption" value=3 onclick="addTask(event,3)">This week</li>
			<li><input type="radio" name="taskOption" value=4 onclick="addTask(event,4)">This month</li>
			<li><input type="radio" name="taskOption" value=5 onclick="addTask(event,5)">This year</li>
			<li><input type="radio" name="taskOption" value=0 checked onclick="this.checked&&_task(function(t){t&&$(cmdtask).removeClass('tasked')&&t.destroy();done()})">No Plan</li>
		</ul>
		<script>
			function _favorite(f){
				Parse.first('favorite','author',Parse.user().id,'post',runtime.post.id,f)
			}
			function _task(f){
				Parse.first('task','author',Parse.user().id,'post',runtime.post.id,'status',1,f)
			}
			function showPost(p){
				setTitle(p.get('title'))
				tmplPost.clean().build(runtime.post=p)
				Parse.find('story','post',p.id,tmplStory)
				_task(function(t,b){
					$(cmdtask)[((b=t&&t.get('status'))?'add':'remove')+'Class']('tasked')
					b&&($('#taskOption [value="'+t.get('type')+'"]')[0].checked=true)
				})
				_favorite(function(t){
					$(cmdfavorite)[(t&&t.get('status')?'add':'remove')+'Class']('favorited')
				})
			}
			function showTaskOption(e){
				$(taskOption).show()
				e.cancelBubble = true
				e.stopPropagation && e.stopPropagation()
				$(document).once('click',function(){$(taskOption).hide()})
			}
			function toggleFavorite(){
				_favorite(function(f,a){
					(f=f||Parse.object('favorite','post',(a=runtime.post).id,'title',a.get('title'),'thumbnail',a.get('thumbnail')))
						.set('status',f.get('status')?0:1)
					f.save().then(function(){$(cmdfavorite)[(f.get('status')?'add':'remove')+'Class']('favorited');done()},Parse.error)
				})
			}			
			function addTask(e,v){
				this.checked && _task(function(t,a){
					(t=t||Parse.object('task','post',(a=runtime.post).id,'title',a.get('title'),'thumbnail',a.get('thumbnail'),'status',1))
						.set('type',v)
					t.save().then(function(){$(cmdtask).addClass('tasked');done()},Parse.error)
				})				
			}
			
		</script>
	</section>
	<section id="favorite" data-transition="slide">
		<header data-title="My Favorites" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="favorite1" class="list scroll" data-on-load="Parse.find('favorite','author',Parse.user().id,tmplFavorite)">
			<ul>
				<script type="text/tmpl" id="tmplFavorite">
				{{#loop}}
				<li class="thumb arrow">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{post}}'}" href="#">{{attributes.title}}</a></strong>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
	</section>
	<section id="task" data-transition="slide">
		<header data-title="My Tasks" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article id="task1" class="list scroll" data-on-load="Parse.find('favorite','author',Parse.user().id,tmplTask)">
			<ul>
				<script type="text/tmpl" id="tmplTask">
				{{#loop}}
				<li class="thumb arrow">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onmouseup="runtime.post={id:'{{post}}'}" href="#">{{attributes.title}}</a></strong>
					</div>
				</li>
				{{/loop}}
				</script>
			</ul>
		</article>
	</section>
	<section id="comment" data-transition="slide">
		<header data-title="Comment" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right"></a>
			</nav>
		</header>
		<article class="list scroll" id="showComments" data-on-load="Parse.find('comment','post',runtime.post,tmplComment)">
			<ul>
				<script type="text/tmpl" id="tmplComment">
				{{#loop}}
					<li class="thumb">
						<a href="#" data-icon="user"><br>{{attributes.authorName}}</a>
						<div>
							<p>{{{attributes.content}}}</p>
							<span class="on-right">{{ago}}</span>
						</div>
					</li>
				{{/loop}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a><form id="commentCreator"
					onsubmit="this.object('comment','post',runtime.post).save().then(function(c){tmplComment.build({loop:[c]});commentCreator.content.value='';done()},Parse.error);return false;">
					<textarea style="height:46px;padding:5px;width:100%;margin:0" name="content"></textarea>
				</form></a>
				<button data-icon="save" type="submit" form="comemntCreator"></button>
			</nav>
		</footer>
	</section>
	
	<section id="creator" data-transition="slide">
		<header data-title="Create Post" data-back="left-sign">
			<nav>
				<button class="on-right" type="submit" form="postCreator" data-icon="save"></button>
			</nav>
		</header>
		<article id="createPost"
			data-on-load="setTitle('Create A '+runtime.cat.name)">
			<form id="postCreator" onsubmit="savePost(this);return false">
				<fieldset><input type="text" placeholder="title" name="title"></fieldset>
				<fieldset><textarea name="content" class="editor" contenteditable="true">content</textarea></fieldset>
				<fieldset>
					<div>
						<input type="checkbox" name="tags" value="N5zSTzoczQ" checked="checked">Boy
						<input type="checkbox" name="tags" value="DJIUvgiFpk">Girl
					</div>
					<div>
						<select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
					</div>
				</fieldset>
				<input type="submit" class="outview">
			</form>
		</article>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick="insertImage()"></a>
				<a data-icon="trash" onclick=""></a>
			</nav>
		</footer>
		<script>
		function savePost(p,newPost){
			doing()
			newPost=p.object('post',"category",runtime.cat.name,"duration", parseInt(p.duration.text()))
			newPost.addUnique("tags", p.duration.value())
			newPost.addUnique("tags",runtime.cat.id)
			newPost.save().then(function(){Lungo.Router.back();done()},Parse.error)
		}
		</script>		
	</section>
	<section id="story" data-transition="slide">
		<header data-back="left-sign" data-title="Create Story">
			<nav>
				<button class="on-right" type="submit" form="storyForm" data-icon="save"></button>
			</nav>
		</header>
		<article id="createStory">
			<form id="storyForm" onsubmit="this.object('story','post',runtime.post.id,'duration', parseInt(p.duration.text())).save().then(Lungo.Rounter.back,Parse.error);return false">
				<fieldset><select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
				</fieldset>
				<fieldset><textarea placeholder="content" name="content"></textarea></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick=""></a>
				<a data-icon="minus" onclick=""></a>
			</nav>
		</footer>	
	</section>	
	
	<section id="user" data-transition="slide">
		<header data-back="left-sign" data-title="User Account"></header>
		<nav data-control="groupbar">
			<a href="#" data-view-article="signin" data-title="Sign In">Sign In</a>
			<a href="#" data-view-article="signup" data-title="Sign up">Sign Up</a>
			<a href="#" data-view-article="forgetpassword" data-title="Forget Password">Forget Password</a>
		</nav>
		<article id="signin">
			<form onsubmit="this.object(new Parse.User()).logIn().then(Lungo.Router.back,Parse.error);return false">
				<fieldset><input name="username" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="password" type="password" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="signup">
			<form onsubmit="this.object(new Parse.User()).signUp().then(Lungo.Router.back,Parse.error);return false">
				<fieldset><input name="username" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="email" type="email" placeholder="email where reset password will be sent"></fieldset>
				<fieldset><input name="password" type="text" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="forgetpassword">
			<form onsubmit="Parse.User.requestPasswordReset(this.email.value);return false">
				<fieldset><input name="email" type="text" placeholder="email where new password would send"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>			
		<footer>
			<nav>
				<a data-icon="ok-sign" onclick="form().submit()"></a>
			</nav>	
		</footer>
	</section>
	<section id="child" data-transition="slide">
		<header data-back="left-sign" data-title="Add baby"></header>
		<article id="child1" data-on-load="Parse.get('child',runtime.child.id).then(function(c){childForm.set(c)},Parse.error)" data-on-unload="runtime.child=null">
			<form id="childForm" 
				onsubmit="this.object('child','parent',Parse.user().id).save().then(Lungo.Router.back,Parse.error);return false">
				<input type="hidden" name="id">
				<fieldset><input type="text" name="name" placeholder="baby name"></fieldset>
				<fieldset>
					<select name="gender">
						<option value=0>Boy</option>
						<option value=1>Girl</option>
					</select>
				</fieldset>
				<fieldset><input type="date" name="birthday" placeholder="birthday"></fieldset>
				<fieldset>
					<img name="photo" onclick="uploader.bind(this).click()" 
						style="width:150px;height:150px;border:1px solid;background-color:lightgray;display:block;margin:0px auto" 
						placeholder="photo"/>
				</fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="certificate" onclick="runtime.child=extracChild()"></a>
				<button type="submit" form="childForm" data-icon="ok-sign"></button>
			</nav>
		</footer>
		<script>
		function loadChild(id){
			Parse.get('child',id).then(function(p,f){
					(f=form()).name.value=p.get('name')
					f.gender.value(p.get('gender'))
					f.birthday.value=p.get('birthday')
					(f.photo.value=p.getFile('photo')) && (f.photo.src=f.photo.value.url())
					f.id.value=p.id	
					done()
				},Parse.error)
		}
		</script>
	</section>
	<script src="res/lungo.debug.js"></script>		
	<script>	
		$("script[type*=tmpl]").each(function(i,tmpl,b,e){
			this.target=$(this).data('target')||this.parentNode
			this.compiled=Mustache.compile((b=this.innerHTML))
			Mustache.compilePartial(this.id,b)
			this.innerHTML=""
			this.build=function(a,container){
				var el=$($.fragment(this.compiled(a))
					.filter(function(el){return el.nodeType!=3}))
					.addClass('tmpled')
				$(container||this.target).append(el)
				Lungo.Boot.Data.init(el)
			}
			this.clean=function(container){
				$(container||this.target,'.tmpled').remove()
				return this
			}
		})
		
		$("a[data-icon='refresh']").each(function(i,a){
			$(a).on('click',function(){$(article()).trigger('load')})
		})
		
		$.each(["load","unload"],function(index,e){//support data-on-(un)load	
			$("[data-on-"+e+"]").each(function(i,el){
				(el=$(this)).on(e,new Function('e,a,b,c',el.data('on-'+e)))
			})
		})
		Lungo.init({
			name:"SNB",
			history:false
		})
		
		checkLogin()
	</script>
	<input type="file" id="uploader" class="outview" onchange="this.save()">
	<script>
		uploader.bind=function(a,opt){
			this.holder=a
			a.opt=opt
			return this			
		}
		uploader.save=function(){
			doing()
			var file=new Parse.File(this.files[0].name,this.files[0]),
				holder=this.holder
			file.save(holder.opt||{
				success: function(f){
					holder.src=f.url()
					holder.file=holder.value=f
					done()
				},
				error: Parse.error
			})
		}
	</script>
 </body>
</html>

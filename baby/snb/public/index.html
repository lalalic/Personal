<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Super Nai Ba</title>
	<link rel="stylesheet" href="res/lungo.css">
	<link rel="stylesheet" href="res/lungo.icon.css">
	<link rel="stylesheet" href="res/lungo.theme.css">
	<style>
		#show img{margin-left: auto;margin-right:auto;display:block}
		[contenteditable=true]{background-color:white;height:100%;padding:10px}
		.outview{position:absolute;top:-9999px;height:1px}
		nav img{width:32px;height:32px}
		.editor{-webkit-user-select:text;-moz-user-select:text;user-select:text;overflow-y: auto}
		#taskOption{z-index:99;position:absolute;bottom:46px;right:0px; display:none;background:white}
		.show{display:auto}
	</style>
	<script src="res/quo.js"></script>
	<script src="res/mustache.js"></script>
	<script src="res/parse-1.2.8.min.js"></script>
	<script>	
		NodeList.prototype.each=Array.prototype.each=function(f){for(var i=0,l=this.length;i<l;i++) f(this[i])}
		$form=function(){return Lungo.dom('section.show article.active form')[0]}
		Parse.initialize("CxZhTKQklDOhDasWX9hidldoK7xtzEmtcl5VSBeL","RwqvvbakVmWPhtO78QCUppfnclzfZ2SyUZ198ArG")
		window.runtime={}
		create=function(f,a){a=Parse.Object.extend(f);return new a}
		HTMLSelectElement.prototype.value=function(){return this.options[this.selectedIndex].value}
		HTMLSelectElement.prototype.text=function(){return this.options[this.selectedIndex].text}
	</script>
</head>
<body>
	<section id="home" data-transition="slide">
		<header data-title="SNB">
			<nav>
				<a href="#" class="on-left" data-icon="home"></a>
				<a href="#" class="on-right" data-icon="user" data-view-menu="users"></a>
			</nav>
		</header>
		<nav data-control="menu" id="users" class="icons">
			<a href="#" data-icon="signout" onclick="signout()"></a>
			<a href="#" data-icon="plus-sign" data-view-section="child"></a>
			<script type="text/tmpl" id="tmplChildren">
				{{#children}}
				<a href="#" data-icon="user" data-view-section="child" onclick="loadChild('{{id}}')"><img src="{{attributes.photo._url}}"></a>
				{{/children}}
			</script>
		</nav>
		<article id="categories" class="list scroll indented" data-on-load="loadCats();checkLogin()">
			<ul>
				<script type="text/tmpl" id="tmplCate">
				{{#categories}}
				<li class="thumb cat" data-count="{{attributes.posts}}">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="category" onclick="loadPosts('{{attributes.name}}','{{id}}')" href="#">{{attributes.name}}</a></strong>
						<small>{{attributes.desc}}</small>
						<a class="on-right" data-view-section="creator" 
							onclick="runtime.cat={name:'{{attributes.name}}',id:'{{id}}'}" 
							style="font-family:lungojsicon;cursor:pointer">&#xf067;</a>
						
					</div>
				</li>
				{{/categories}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>

			</nav>
		</footer>
		<script>
		function checkLogin(){
			Parse.User.current() ? loadChildren() : setTimeout(function(){Lungo.Router.section('user')},1000)
		}
		
		function loadChildren(){
			var children=new Parse.Query(Parse.Object.extend('child'))
			children.equalTo("parent",Parse.User.current().id)
			children.find({
				success: function(children){
					children && tmplChildren.build({children:children})
					children && !runtime.child && (runtime.child=children[0])
				},
				error: function(){}
			})
		}
		function loadCats(){
			var categories=new Parse.Query(Parse.Object.extend('tag'))
			categories.equalTo("category","category");
			categories.find({
				success:function(cats){
					tmplCate.build({categories:cats})
				},
				error: function(){
					Lungo.Article.clear('categories')
				}
			})
			loadCats=new Function();
		}
		function loadPosts(cat,id){
			runtime.cat={name:cat,id:id}
			Lungo.dom(".active .post").remove()
			var posts=new Parse.Query(Parse.Object.extend('post'))
			posts.equalTo("category",cat)
			posts.find({
				success:function(posts){
					tmplPosts.build({posts:posts})
				},
				error: function(){
					Lungo.Article.clear('posts')
				}
			})
		}
		</script>
	</section>
	<section id="category" data-transition="slide">
		<header data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right" onclick=""></a>
			</nav>
		</header>
		<article id="posts" class="list scroll">
			<ul>
				<li>
					<div style="position:relative;height:300px;background-color:black"></div>
				</li>
				<script type="text/tmpl" id="tmplPosts">
				{{#posts}}
				<li class="thumb arrow post">
					<img src="{{attributes.thumbnail._url}}">
					<div>
						<strong><a data-view-section="post" onclick="loadPost('{{id}}')" href="#">{{attributes.title}}</a></strong>
					</div>
				</li>
				{{/posts}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a data-icon="plus" data-view-section="creator"></a>
				<a data-icon="share" data-view-section="creator"></a>
			</nav>
		</footer>
		<script>
		function loadPost(id){
			Lungo.dom(".active .postshow").remove()
			new Parse.Query(Parse.Object.extend("post")).get(id,{
				success:function(p){
					runtime.post=p
					tmplPost.build(p)
					var stories=new Parse.Query(Parse.Object.extend('story'))
					stories.equalTo('parent',id)
					stories.find({
						success: function(stories){
							tmplStory.build({stories:stories},'#stories')
							_task(function(t){
								if(t!=null && t.get('status')){
									Lungo.dom('#cmdtask').addClass('tasked')
									Lungo.dom('#taskOption [value='+t.get('type')+']')[0].checked=true
								}else
									Lungo.dom('#cmdtask').removeClass('tasked')
							})
							_favorite(function(t){
								if(t!=null && t.get('status'))
									Lungo.dom('#cmdfavorite').addClass('favorited')
								else
									Lungo.dom('#cmdfavorite').removeClass('favorited')
							})
						},
						error: function(){
							
						}
					})
				},
				error: function(p,error){
				
				}
			})
		}
		</script>
	</section>
	<section id="post" data-transition="slide">
		<header data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right" onclick=""></a>
			</nav>
		</header>
		<article id="show" data-on-load="taskReady()">
			<div style="padding:5px">
			<script type="text/tmpl" id="tmplPost">
				<div class="postshow" id="{{id}}">
					<strong>{{title}}<span class="on-right"><a>{{author}}</a><span>{{modifedAt}}</span></span></strong>
					<div>{{{attributes.content}}}</div>
					<ul class="list scroll" id="stories"></ul>
				</div>
			</script>
			<script type="text/tmpl" id="tmplStory">
				{{#stories}}
				<li class="thumb story">
					<img src="{{attributes.thumbnail._url}}">
					<p>{{{attributes.content}}}</p>
				</li>
				{{/stories}}
			</script>
			</div>
		</article>
		<footer>
			<nav>
				<a data-icon="comment" data-view-section="comment" onclick="loadComments(runtime.post.id)" href="#"></a>
				<a data-icon="film" data-view-section="story" onclick="" href="#"></a>
				<a data-icon="share" data-view-section="comment" onclick="" href="#"></a>
				<a data-icon="star" id="cmdfavorite" onclick="doFavorite(this)" href="#"></a>
				<a data-icon="menu" id="cmdtask" onclick="Lungo.dom('#taskOption').toggleClass('show')" href="#"></a>
			</nav>
		</footer>
		<div id="taskOption">
			<input type="radio" name="taskOption" value="0">Today			
			<input type="radio" name="taskOption" value="1">Tomorrow
			<input type="radio" name="taskOption" value="2">This week
			<input type="radio" name="taskOption" value="3">This month
			<input type="radio" name="taskOption" value="4">This year
			<input type="radio" name="taskOption" value="0">Remove
		</div>
		<script>
			function _favorite(f){
				var q=new Parse.Query(Parse.Object.extend("favorite"))
				q.equalTo("owner",Parse.User.current().id)
				q.equalTo('post',runtime.post.id)
				q.first().then(function(fav){f(fav)})
			}
			function doFavorite(el){
				_favorite(function(f){
					if(f==null){
						f=create('favorite')
						f.set('post',runtime.post.id)
						f.set('title',runtime.post.get('title'))
						f.set('thumbnail',runtime.post.get('thumbnail'))
						f.set('status',1)
					}else if(f.get('status')==0)
						f.set('status',1)
					else
						f.set('status',0)
					f.save().then(function(){el.classList[f.get('status')?'add':'remove']('favorited')})
				})
			}
			function taskReady(){
				Lungo.dom('#taskOption input').click(function(){
					var me=this
					_task(function(t){
						if(me.value=='0'){
							if(t!=null){
								t.remove()
								me.classList.remove('tasked')
								return
							}
						}else if(t==null){
							t=create('task')
							t.set('post',runtime.post.id)
							t.set('title',runtime.post.get('title'))
							t.set('thumbnail',runtime.post.get('thumbnail'))
							t.set('status',1)
						}
						t.set('type',parseInt(me.value))
						t.save().then(function(){me.classList.add('tasked')})
					})
				})
				taskReady=empty
			}
			function _task(){
				var q=new Parse.Query(Parse.Object.extend("task"))
				q.equalTo("owner",Parse.User.current().id)
				q.equalTo('post',runtime.post.id)
				q.equalTo('status',1)
				q.first().then(function(fav){f(fav)})
			}
		</script>
	</section>
	<section id="comment" data-transition="slide">
		<header data-title="Comment" data-back="left-sign">
			<nav>
				<a data-icon="refresh" class="on-right" onclick=""></a>
			</nav>
		</header>
		<article class="list" id="showComments" data-on-load="commentContent.focus()">
			<ul>
				<script type="text/tmpl" id="tmplComment">
				{{#comments}}
					<li class="comment">
						<p>{{{attributes.content}}} <span class="on-right">{{author}} on {{createdAt}}</span></p>
					</li>
				{{/comments}}
				</script>
			</ul>
		</article>
		<footer>
			<nav>
				<a><textarea style="height:46px;padding:5px;width:100%" id="commentContent"></textarea></a>
				<button data-icon="save" onclick="saveComment()"></button>
			</nav>
		</footer>
		<script>
		function loadComments(id){
			Lungo.dom(".active .comment").remove()
			var comments=new Parse.Query(Parse.Object.extend('comment'))
			comments.equalTo("post",runtime.post)
			comments.find({
				success:function(comments){
					tmplComment.build({comments:comments})
				},
				error: function(){
					Lungo.Article.clear('showComments')
				}
			})
		}
		
		function saveComment(){
			var comment=create('comment')
			comment.set("content",commentContent.value)
			comment.set("post", runtime.post)
			comment.save().then(function(){
				tmplComment.build({comments:[comment]})
				commentContent.value=""
			})
		}
		</script>
	</section>
	
	<section id="creator" data-transition="slide" 
		data-on-load="setTimeout(function(){Lungo.dom('#creator header h1').text('Create '+runtime.cat.name)},300)">
		<header data-title="Create Post" data-back="left-sign">
			<nav>
				<button class="on-right" type="submit" form="creatForm" data-icon="save"></button>
			</nav>
		</header>
		<article id="createPost">
			<form id="creatForm" onsubmit="savePost();return false">
				<fieldset><input type="text" placeholder="title" name="title"></fieldset>
				<fieldset><textarea name="content" class="editor" contenteditable="true">content</textarea></fieldset>
				<fieldset>
					<div>
						<input type="checkbox" name="gender" value="N5zSTzoczQ" checked="checked">Boy
						<input type="checkbox" name="gender" value="DJIUvgiFpk">Girl
					</div>
					<div>
						<select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
					</div>
				</fieldset>
				<input type="submit" class="outview">
			</form>
		</article>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick="insertImage()"></a>
				<a data-icon="trash" onclick=""></a>
			</nav>
		</footer>
		<script>
		function savePost(){
			var newPost=create('post'),
				p=$form()
			newPost.set("content",p.content.value)
			newPost.set("title",p.title.value)
			newPost.set("category",runtime.cat.name)
			newPost.set("duration", parseInt(p.duration.text()))
			newPost.addUnique("tags", p.duration.value())
			newPost.addUnique("tags",runtime.cat.id)
			p.gender.each(function(a){a.checked && newPost.addUnique("tags",a.value)})
			newPost.save().then(Lungo.Router.back)
		}
		</script>		
	</section>
	<section id="story" data-transition="slide">
		<header data-back="left-sign" data-title="Create Story">
			<nav>
				<button class="on-right" type="submit" form="storyForm" data-icon="save"></button>
			</nav>
		</header>
		<article id="createStory">
			<form id="storyForm" onsubmit="saveStory();return false">
				<fieldset><select name="duration">
							<option value="KknqyCi9x2">60</option>
							<option value="ueOPMH3mSR">10</option>
							<option value="MNWQyARcTj">30</option>
							<option value="xWiqWf3msh">45</option>
							<option value="4NZdgfvDpV">90</option>
							<option value="5BqICFnfKY">120</option>
						</select>
				</fieldset>
				<fieldset><textarea placeholder="content" name="content"></textarea></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="picture" onclick=""></a>
				<a data-icon="minus" onclick=""></a>
			</nav>
		</footer>	
		<script>
		function saveStory(){
			var newStory=create('story')
			newStory.set("content",postContent.value)
			newStory.set("post",runtime.post.id)
			newStory.set("duration", parseInt(p.duration.text()))
			newStory.save().then(Lungo.Router.back)
		}
		</script>		
	</section>	
	
	<section id="user" data-transition="slide">
		<header data-back="left-sign" data-title="User Account"></header>
		<nav data-control="groupbar">
			<a href="#" data-view-article="signin" data-title="Sign In">Sign In</a>
			<a href="#" data-view-article="signup" data-title="Sign up">Sign Up</a>
			<a href="#" data-view-article="resetpassword" data-title="Reset Password">Reset Password</a>
			<a href="#" data-view-article="forgetpassword" data-title="Forget Password">Forget Password</a>
		</nav>
		<article id="signin">
			<form onsubmit="signin();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="password" type="password" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="signup">
			<form onsubmit="signup();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="email" type="email" placeholder="email where reset password will be sent"></fieldset>
				<fieldset><input name="password" type="text" placeholder="password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="resetpassword">
			<form onsubmit="resetpassword();return false">
				<fieldset><input name="name" type="text" placeholder="user name"></fieldset>
				<fieldset><input name="password" type="password" placeholder="old password"></fieldset>
				<fieldset><input name="password" type="password" placeholder="new password"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<article id="forgetpassword">
			<form onsubmit="forgetpassword();return false">
				<fieldset><input name="email" type="text" placeholder="email where new password would send"></fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>			
		<footer>
			<nav>
				<a data-icon="ok-sign" onclick="$form().submit()"></a>
			</nav>	
		</footer>
		<script>
		function signin(){
			var user=$form()
			Parse.User.logIn(user.name.value, user.password.value,{
				success:function(){
					Lungo.Notification.success("signin","Success", "ok")
					Lungo.Router.back()
				},
				error: function(user, error){
					Lungo.Notification.success("signup",error, "error")
				}
			})
			return false
		}
		
		function signup(){
			var userForm=$form()
			var user=new Parse.User()
			user.setUsername(userForm.name.value)
			user.setPassword(userForm.password.value)
			user.setEmail(userForm.email.value)
			
			user.signUp(null,{
				success:function(){
					Lungo.Notification.success("signup","Success", "ok")
					Lungo.Router.back()
				},
				error: function(user, error){
					Lungo.Notification.success("signup",error, "canncel")
				}
			})
			return false
		}
		
		function signout(){
			Parse.User.logOut()
			location.reload()
		}
		</script>
	</section>
	<section id="child" data-transition="slide">
		<header data-back="left-sign" data-title="Add baby"></header>
		<article id="child1">
			<form id="childForm" onsubmit="try{saveChild()}catch(error){alter(error)}return false">
				<input type="hidden" name="id">
				<fieldset><input type="text" name="name" placeholder="baby name"></fieldset>
				<fieldset>
					<select name="gender">
						<option value=0>Boy</option>
						<option value=1>Girl</option>
					</select>
				</fieldset>
				<fieldset><input type="date" name="birthday" placeholder="birthday"></fieldset>
				<fieldset>
					<img name="photo" onclick="uploader.bind(this).click()" 
						style="width:150px;height:150px;border:1px solid;background-color:lightgray;display:block;margin:0px auto" 
						placeholder="photo"/>
				</fieldset>
				<fieldset class="outview"><input type="submit"></fieldset>
			</form>
		</article>
		<footer>
			<nav>
				<a data-icon="certificate" onclick="makeDefaultChild()"></a>
				<button type="submit" form="childForm" data-icon="ok-sign"></button>
			</nav>
		</footer>
		<script>
		function makeDefaultChild(){
			runtime.child=extracChild()
		}
		function extractChild(){
			var child=create('child'),
				f=$form()
			child.set("name",f.name.value)
			child.set("gender",f.gender.selectedIndex)
			child.set("birthday", f.birthday.value)
			child.set("photo", f.photo.file)
			child.set("parent", Parse.User.current())
			child.id=f.id.value
			return child
		}
		function saveChild(){
			var child=extractChild()
			child.save(null,{
				success: function(){
					Lungo.Router.back()
				},
				error: function(error){
					Lungo.Notification.success("Save Child",error, "canncel")
				}
			})
		}
		function loadChild(id){
			new Parse.Query(Parse.Object.extend("child")).get(id,{
				success:function(p){
					tmplPost.build(p)
					var stories=new Parse.Query(Parse.Object.extend('story'))
					stories.equalTo('parent',p)
					stories.find({
						success: function(stories){
							tmplStory.build({stories:stories},'#stories')
						},
						error: function(){
							
						}
					})
				},
				error: function(p,error){
				
				}
			})
		}
		</script>
	</section>
	<script src="res/lungo.debug.js"></script>		
	<script>	
		Lungo.dom("script[type*=tmpl]").each(function(i,tmpl,b){
			this.compiled=Mustache.compile((b=this.innerHTML))
			Mustache.compilePartial(this.id,b)
			this.innerHTML=""
			this.build=function(a,container){
				Lungo.dom(container||this.parentNode).append(this.compiled(a))
			}
		})
		
		new Array("load","unload").each(function(e){//support data-on-(un)load	
			Lungo.dom("[data-on-"+e+"]").each(function(i,el){
				(el=Lungo.dom(this)).on(e,new Function('e,a,b,c',el.data('on-'+e)))
			})
		})
		Lungo.init({
			name:"SNB",
			history:false
		})
	</script>
	<input type="file" id="uploader" class="outview" onchange="this.save()">
	<script>
		uploader.bind=function(a,opt){
			this.holder=a
			a.opt=opt
			return this			
		}
		uploader.save=function(){
			var file=new Parse.File(this.files[0].name,this.files[0]),
				holder=this.holder
			file.save(holder.opt||{
				success: function(f){
					holder.src=f.url()
					holder.file=f
				},
				error: function(error){
					Lungo.Notification.success("upload",error, "error")
				}
			})
		}
	</script>	
 </body>
</html>

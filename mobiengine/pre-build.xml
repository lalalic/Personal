<?xml version="1.0" encoding="UTF-8"?>
<project name="pre-build" default="main">
	<property name="root" value="${ant.file}/.."/>
	<target name="main">
		<copy todir="${root}/src/libs" file="${root}/war/yang/js/plugins/model.js"/>
		<java classname="org.mozilla.javascript.tools.jsc.Main">
			<arg value="-d"/>
			<arg value="${root}/build"/>
			<arg value="${root}/war/yang/js/libs/r.js"/>
			<classpath>
				<pathelement location="${root}/war/WEB-INF/lib/js.jar"/>
			</classpath>
		</java>
		<antcall target="mergejs"/>
		<antcall target="mergecss"/>
		<antcall target="app.html"/>
	</target>
	
	<target name="compiler">
		<java classname="org.mozilla.javascript.tools.jsc.Main">
			<arg value="-d"/>
			<arg value="${root}/war/WEB-INF/classes"/>
			<arg value="-package"/>
			<arg value="libs.compiled"/>
			<arg value="${root}/src/libs/underscore-min.js"/>
			<arg value="${root}/src/libs/backbone-min.js"/>
			<arg value="${root}/src/libs/promise.js"/>
			<arg value="${root}/src/libs/model.js"/>
			<classpath>
				<pathelement location="${root}/war/WEB-INF/lib/js.jar"/>
			</classpath>
		</java>
	</target>
	
	<target name="mergejs">
		<java dir="${root}/war/yang" classname="r">
			<jvmarg value="-Xss8M"/>
			<arg value="-o"/>
			<arg value="${root}/war/yang/build.js"/>
			<arg value="out=${root}/build/bootstrap.js"/>
			<classpath>
				<pathelement location="${root}/war/WEB-INF/lib/js.jar"/>
				<pathelement path="${root}/build"/>
			</classpath>
		</java>
	</target>
	
	<target name="mergecss">
		<java dir="${root}/war/yang" classname="r">
			<jvmarg value="-Xss8M"/>
			<arg value="-o"/>
			<arg value="cssIn=${root}/war/yang/build.css"/>
			<arg value="out=${root}/build/bootstrap.css"/>
			<classpath>
				<pathelement location="${root}/war/WEB-INF/lib/js.jar"/>
				<pathelement path="${root}/build"/>
			</classpath>
		</java>
	</target>
	
	<target name="app.html">
		<loadfile property="requirejs" srcfile="${root}/war/yang/js/libs/require.js"/>
		<loadfile property="css" srcfile="${root}/build/bootstrap.css">
			<filterchain>
				<tokenfilter>
					<replacestring from="url(css/" to="url(/yang/css/"/>
				</tokenfilter>
			</filterchain>
		</loadfile>
		<loadfile property="js" srcfile="${root}/build/bootstrap.js"/>
		<copy file="${root}/war/yang/build.html" tofile="${root}/build/app.html">
			<filterchain>
				<replacetokens>
					<token key="STYLE" value="${css}"/>
					<token key="REQUIREJS" value="${requirejs}"/>
					<token key="SCRIPT" value="${js}"/>
					<token key="SERVICE.VERSION" value="1"/>
				</replacetokens>
			</filterchain>
		</copy>
		<gzip src="${root}/build/app.html" destfile="${root}/war/yang/app.gz.html"/>
		<move file="${root}/build/app.html" tofile="${root}/war/yang/app.html"/>
	</target>
</project>
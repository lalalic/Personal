<#macro body>
    <#assign 
        defaultThumb="/extend/rs/images/logo.png"
        NodeTypes=["path","dinner","bed","view","culture","shopping","fun","charity","business","region","route"]
        TransTypes=["drive","train","airplane","bycicle","foot","boat","bus","taxi"]>


	<div id="map"></div>
	<div id="sidebar" class="mini">
		<div style="margin:0 auto">
			<@content/>
			<@sidebox title="Map Tools">
			     <@more>
    				<textarea style="height:3em"
    					placeholder="beijing|fly->shanghai|train->lasha..."></textarea>
				</@more>
				<div id="plantoolbar">
					<form onsubmit="module.submitLocation(); return false" style="display:inline">
						<@suggestInput action="/route/suggest;status=10;title*=" onsuggest="module.insertRoute(id,title)">
							id="location" style="width:7em" placeholder="place|route"
						</@suggestInput>
					</form>
					<button onclick="module.tree.remove()" title="Remove">x</button>
					<button onclick="module.tree.up()" title="move up">&uarr;</button>
					<button onclick="module.tree.down()" title="move down">&darr;</button>
					<button onclick="module.tree.promote()" title="move left">&larr;</button>
					<button onclick="module.tree.demote()" title="move right">&rarr;</button>
					<button onclick="module.drawRoute()" title="draw">&sect;</button>
				</div>	

				<ul class="tree" id="plan"></ul>	
				<form id="editDialog" onsubmit="return false;">
					<input name="name" placeholder="当前地点名称" style="width:100%"><br/>
					<select name="trans" style="width:140px">
                        <@optionUI options=TransTypes mode="IndexName"/>
                        <option value="99">other</option>
                    </select>
					<select name="type" style="width:140px;float:right">
						<@optionUI options=NodeTypes mode="IndexName"/>
						<option value="99">other</option>
					</select><br/>
					<@more>
						<input type="date" name="date" style="width:10em">
						<input type="time" name="time">
					</@more>
					<@editor name="desc">style="width:250px;height:4em"</@editor>
				</form>
			</@sidebox>
		</div>
	</div>
	</div>
	<div id="outline">
	    <img style="background-image:url(${defaultThumb})">
	</div>
	<div id="context">
	    <dl>
	        <dt>insert as
	        <#local i=0>    
    	    <#list NodeTypes as type>
    	       <dd><button onclick="module.insertByName({type:${i}, latlng:module.context.latlng})">${type}</button>
    	       <#local i=i+1>
    	   </#list>
    	   <dt>upload
    	   		<dd><button class="uploadphoto" onclick="module.photoLatlng=module.context.latlng">photoes</button> 
    	   			<button id="uploadtrack1">track</button>
    	   		<#if user.isLoggedIn()>
	            	<script>$('#uploadtrack1').uploader({service:'/track/upload',beforeSubmit:$.noop})</script>
	            </#if>
	   </dl>
	</div>
	<#noparse>
	<script type="text/tmpl" id="tmplTree">
		<li><div><img src="http://maps.gstatic.com/intl/zh_cn/mapfiles/transparent.png"/>
				<span><!--img class="node${type}" src="http://maps.gstatic.com/intl/zh_cn/mapfiles/transparent.png"/--><span>${name}</span></span></div>
			{{if children}}
			<ul style="display:none">
				{{tmpl(children) "#tmplTree"}}
			</ul>
			{{/if}}
		</li>
	</script>
	</#noparse>
</#macro>

<#macro tmplCss>
<style> 
	body{overflow:hidden;background-color:black}
	.round{border-radius:5px}
	.container{margin:0px!important;overflow:hidden;background-color:black}
	#map{width:75%;height:99%;position:absolute;overflow:hidden;}
	
	#sidebar{width:60%; height:100%;position:absolute;overflow:hidden; overflow-y:scroll;background:white;}	
	#sidebar.mini{width:25%;padding:5px;right:5px/*left:78%*/}
	#sidebar.focus{right:0;opacity: 0.98}
	#sidebar textarea{width:100%}
	.sidebox h4{background-color: orange;line-height: 2em;padding: 2px;margin-top: -20px;}
	.sidebox h4 a{text-decoration:none}
	
	.sidebox .content img{width:75px!important}
	
	#plan{font-size:9pt;background:black;color:white;border:2px solid gray;opacity:0.8;min-height:250px;margin-top:5px}
	.tree{margin:0px;padding:0px}
	.tree ul{padding:2px 17px;}
	.tree li{cursor:default;list-style:none;line-height:25px;}
	.tree li div{border:1px transparent solid;white-space:nowrap;}
	.tree li div:hover{border-color:Beige}
	.tree li div img{width:16px;height:16px;margin:-2px 1px}
	.tree li.folder>div>img{background:url(/extend/rs/images/arrow.png) center no-repeat}
	.tree li.open>div>img{background:url(/extend/rs/images/arrow_down.png) center no-repeat}
	.tree li.current>div{background-color:Azure;color:black}
	img.more{float:right;margin-right:10px;background:url(/extend/rs/images/arrow.png) no-repeat 8px 8px;width:16px;height:16px}
	#context{font-size:9pt;position:absolute;min-width:200px;display:none;background:black;color:white;border:2px solid gray;opacity:0.8}
	#context dd{display:inline}
	
	#plantoolbar button{margin:0;border:0px}
	.toolbar input{padding-left:0!important;margin-right:0!important;text-indent:-9999px;height:20px}
	.content img{width:100px!important}
	#outline img{width:150px;height:150px;opacity:0.6}
	#toolbar{opacity:0.8;height:50px;}
	#layers{position:absolute;display:none;background:black;color:white;}
	#outline{display:none}
</style> 
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;libraries=places"></script>
<script type="text/javascript" src="/extend/rs/jquery.tmpl.min.js"></script>
<script type="text/javascript" src="/extend/rs/equ.js"></script>
<script>jQuery(function(){module.start()})</script>
</#macro>

<#macro postForm>
    <#local v=post>
    <#if ((v.ID!0)>0)>
        <#local title="<a href='/plan/show/${v.ID}.shtml'>${v.title}</a>" >
    <#else>
        <#local title="Create Vacation" >
    </#if>
    <@sidebox title=title>
    <form action="/plan/post" method="post"
         onsubmit="this.thumbnail.value=$('#outline img').attr('src'); this.route.value=JSON.stringify(module.tree.getData())">
        <input name="ID" type="hidden" value="${v.ID!}">
        <input name="thumbnail" type="hidden">
        <input name="route" type="hidden">
        <input name="title" placeholder="*题目..." value="${v.title!}" style="width:100%">
        <@editor name="content" placeholder="内容" content=v.content!>style="width:250px;height:4em"</@editor>
        <@more>
        <input type="date" name="start" value="${(v.start!.now)?date}"> -
        <input type="date" name="end" value="${(v.end!.now)?date}">
        </@more>
        <hr/>
        <div class="actions"> <button type="submit" class="right">发布</button> <button type="button" onclick="history.go(-1)">Back</button></div>
    </form>
    </@sidebox>
    <script>vacationID=${v.ID!0};database=${v.route!'null'?js_string}</script>
    <@toolbar/>
</#macro>

<#macro routePostForm>
    <#local v=post>
    <#if v.parent==0>
    	<#local title="分享成熟路线">
    <#else>
    	<#local parent=v.vacation()  title="讨论<a href='/plan/show/${parent.ID}.shtml'>${parent.title}</a>的路线">
    </#if>
    <@sidebox title=title>
    <form action="/route/post" method="post"
         onsubmit="this.thumbnail.value=$('#outline img').attr('src'); this.route.value=JSON.stringify(module.tree.getData())">
        <input name="ID" type="hidden" value="${v.ID!}"> 
        <input name="parent" type="hidden" value="${v.parent!}">
        <input name="thumbnail" type="hidden">
        <input name="route" type="hidden">
        <input name="title" placeholder="*题目..." value="${v.title!}" style="width:100%" required>
        <@editor name="content" placeholder="内容" content=v.content!>style="width:250px;height:4em"</@editor>
        <div class="actions"><button type="submit" class="right">保存</button> <button type="button" onclick="history.go(-1)">Back</button></div>
    </form>
    </@sidebox>
    <script>vacationID=${v.parent!0};database=${(v.route!parent.route)!"null"?js_string}</script>
    <@toolbar/>
</#macro>

<#macro diaryPostForm>
    <#local v=post parent=v.vacation() locus=parent.locus!>
    <@sidebox title="Share for <a href='/plan/show/${parent.ID}.shtml'>${parent.title}</a>">
    <form action="/diary/post" method="post"
         onsubmit="this.thumbnail.value=$('#outline img').attr('src'); this.route.value=JSON.stringify(module.tree.getData())">
        <input name="ID" type="hidden" value="${v.ID!}"> 
        <input name="parent" type="hidden" value="${v.parent!}">
        <input name="thumbnail" type="hidden">
        <input name="route" type="hidden">
        <input type="date" name="start" value="${(v.start!.now)?date}">
        <input name="title" placeholder="*题目..." value="${v.title!}" style="width:100%" required>
        <@editor name="content" placeholder="内容" content=v.content!>style="width:250px;height:4em"</@editor>
        <div class="actions"><button type="submit" class="right">保存</button> <button type="button" onclick="history.go(-1)">Back</button></div>
    </form>
    </@sidebox>
    <script>vacationID=${v.parent!0};database=${(v.route!parent.route)!"null"?js_string}</script>
    <#if locus?has_content>
        <script>
            <#list v.locus.track as point>
                locus.push({time:${point.time},lat:${point.latitude}, lng:${point.longitude}});
            </#list>
        </script>
    </#if>
    <@toolbar/>
</#macro>

<#macro toolbar track=false photo=false layer=false search=true>
<div id="toolbar">
	<button><a href="/">Home</a></button>
	<button><a href="/plan">List</a></button>
	<#if track>
		<button onclick="module.refreshMap()">Refresh</button>
		<button onclick="module.trackPath()">Track</button>
	</#if>
	<#if photo>
		<button onclick="module.photos()">Photo</button>
		<@uploader/>
		<button class="uploadphoto">upload photoes </button>
		<#if user.isLoggedIn()>
       	<script>
       	$('.uploadphoto').uploader({
       		service:'/p/upload',
       		beforeSubmit: function(){
      				$(this).append("<input type='hidden' name='vID' value='"+vacationID+"'>");
      				var p=module.photoLatlng
      				if(p!=null){
      					$(this).append("<input type='hidden' name='lat' value='"+p.lat+"'>")
      						.append("<input type='hidden' name='lng' value='"+p.lng+"'>")
      					module.photoLatlng=null
      				}
				this.action=$.ajax('/media/want2upload/p/upload',{async:false}).responseText
			},
			complete: function(photos){
				var photo
				for(var i=0; i<photos.length;i++){
					photo=photos[i]
					new google.maps.PhotoMarker(module.map,"/media/show/"+photo.ID+".jpg",photo.loc)
				}
			}
		})
		</script>
       </#if>
    </#if>  
    <#if layer> 
		<button onmouseover="$('#layers').show()" onmouseout="$('#layers').hide()">Layers
			<div id="layers">
				<@checkboxUI name="layer" options=["route","attraction","photo"]>checked</@checkboxUI>
			</div>
		</button>
	</#if>
	<#if search>
		<form onsubmit="module.find($('#s').val());return false;" style="display:inline">
			<input id="s" style="width:8em" placeholder="Search">
			<input type="submit" style="width:0px;">
		</form>
	</#if>
</div>
</#macro>

<#macro sidebox title="" expo="" classes="">
    <div class="sidebox box round clear clearfix ${classes}" ${expo}>
        <h4><b>${title}</b><button class="right" onclick="$(this).parents('.sidebox').find('.sideboxcontent').toggle()">+</button></h4>
        <div class="sideboxcontent">
            <#nested>
        </div>
    </div>
</#macro>

<#macro more title="more">
   	<div  style="display:none">
       <#nested>
    </div>
    <a class="right" href="javascript:void(0)" onclick="$(this).prev().toggle()">${title}</a>  
</#macro>
<#macro init>
    <#import "/com/yy/app/cms/web/slavable.html" as slavable>
    <#include "/com/yy/app/cms/web/slavable.html">
    <@slavable.init/>
    <#assign this={'model':'旅行','path':path,'slave':{'model':'路线'}}>
    <#global headMacros=headMacros+['map_rs']>
</#macro>

<#macro map_rs>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&amp;libraries=places"></script>
	<script type="text/javascript" src="/extend/rs/equ.js"></script>
	<script>
	window.entities={}
	function the(id){
		if(id+'' in window.entities)
			return window.entities[id+'']
		else
			return (window.entities[id+'']={})
	}
	function log(){
		
	}
	</script>
</#macro>

<#macro show1Fields post>
	<p class="postcontent">
   	    <div><b>
   	        <#if post.start!?has_content>Date: ${post.start?date?string}</#if>
   	        <#if post.end!?has_content>-- ${post.end?date?string}</#if>
   	        <#if ((post.days!0)>0)> ${post.days}日游</#if>
   	        </b>
   	        <@authorInfo post/>
   	    </div>
   	    ${post.content}
   	</p>
    
   	<#if request.path?index_of('/show;diary/')!=-1>
   	    <#assign this=this+{'model':'旅行','slave':{'model':'日记'}} slaveType=post.setSlaveType("diary")>
   	</#if>
   	
   	<#assign sidebarMacros=sidebarMacros+['pollRoute']  currentPoll=post.currentPoll!>
   	<script>
	   	<#if currentPoll?has_content>var poll=${currentPoll.ID}</#if>
	   	the(${post.ID}).database=${post.route!'null'?js_string};
   	</script>
   	<@map post/>
</#macro>

<#macro thumb post context="plan">
    <#if post.thumbnail??>
        <a href="/${context}/show/${post.ID}.shtml"><img src="${post.thumbnail?replace('150','100')}" style="float:left;width:100px;height:100px;border:0;margin:0;margin-right:5px;padding:0"></a>
    </#if>
</#macro>

<#macro show1SlaveFields slave>
	<p><b>${slave.title}</b><br/><span  class="postcontent">${slave.content}</span><@authorInfo slave/></p>
	<script>the(${slave.ID}).database=${slave.route!'null'?js_string}</script>
</#macro>

<#macro action1Primary post>
    <li>
        <#local v=post>
        <#if v.joinable(user.ID)>
            <@cmd onclick='var self=this;$.get(\'/plan/join/${v.ID}\',function(){alert("joined!");$(self).hide("slow").remove()})' label="我也去"/>
        </#if>
        
        <#if post.author=user.ID><@cmd href='/${this.path}/edit/${post.ID}.shtml' label="修改"/></#if>
        
        <#if !v.ended()>
            <@cmd href='/route/${post.ID}/create.html' label="+路线"/>
        </#if>
        
        <#if !v.ended() && post.started() >
            <@cmd href='/diary/${v.ID}/create.html' label="+日记"/>
            <@cmd href='' label="+轨迹">id="uploadtrack"</@cmd>
            <@uploader/>
            <#if user.isLoggedIn()>
            	<script>$('#uploadtrack').uploader({service:'/track/upload',beforeSubmit:$.noop})</script>
            </#if>
        </#if>
    </li>
</#macro>


<#macro homeList>
    <#list it as post>
        <li class="thumbnail">
            <a href="/plan/show/${post.ID}.shtml">
                ${post.title}
                <img style="width:250px;" src="${post.thumbnail?replace('150','250')}">
            </a>
        </li>
    </#list>
</#macro>

<#macro onroadHomeList>
    <#list it as post>
        <li class="thumbnail" style="position:relative">
            <a href="/plan/show;diary/${post.parent}.shtml" style="position:relative">
                ${post.title}
                <img style="width:250px;" src="${post.thumbnail?replace('150','250')}">
                <img style="position:absolute;bottom:0;right:0;width:75px" src="${post.vacation().thumbnail?replace('150','75')}">
            </a>
        </li>
    </#list>
</#macro>

<#macro pollRoute  post=it!>
    <#--
        author: create, vote, close, show,compare
        member: vote, show,compare
        viewer: show,compare
    -->
    <#local closedPolls=post.closedPolls!>
    <#if !currentPoll??>
        <#local  currentPoll=post.currentPoll!>
    </#if>
    <@sidebox "投票决定" post ; post>
        <div id="pollbox">
        <#if closedPolls?has_content>
            <fieldset>
                <legend>已经关闭的投票</legend>
                <ol> <#list closedPolls as poll><li><a>${poll.title}</a></li></#list></ol>
            </fieldset>
        </#if>
        
        <#if currentPoll?has_content>
            <#local routes=currentPoll.routes!>
            <fieldset>
                <legend>${currentPoll.title}</legend>
                <#if routes?has_content>
                    <#if  post.iPollable()>
                        <#list routes as route>
                            <div>
                                <input type="radio" name="route" value="${route.ID}">
                                <a href="#${route.ID}">${route.title}</a>
                            </div>
                        </#list>
                        </fieldset>
                        <@cmd onclick="selectItem()" label="投一票"/>
                    <#else>
                        <#local results=(currentPoll.results!) i=0>
                        <#list routes as route>
                            <div><a href="#${route.ID}">[${results[i]!0}]${route.title}</a></div>
                            <#local i=i+1>
                        </#list>
                        </fieldset>
                    </#if>
                    
                    <#if user.ID==post.author>
                        <@cmd onclick="closePoll()" label="结束投票"/>
                    </#if>
                    <@cmd href='/poll/compare/${currentPoll.ID}' label="地图上比较"/> 
                    
                <#elseif user.ID=post.author>
                    <span>点击路线的<b>+票</b>作为投票选项</span>
                    </fieldset>
                </#if>
            
        <#elseif user.ID==post.author>
            <form action="/poll/post" method="post">
                <input type="hidden" name="parent" value="${post.ID}">
                <input name="title" placeholder="Poll Goal">
                <button type="submit">+投票</button>
            </form>
        </#if>
        </div>
        <#if currentPoll?has_content><@rsPoll/></#if>
    </@sidebox>
</#macro>

<#macro showSlaveExtra slave>
<ul class="actions right">
    <#if slave.author=user.ID>
        <li>
            <@cmd href='/${slaveType!"route"}/edit/${slave.ID}.shtml' label="修改"/>
            <#if "diary"!=(slaveType!) && currentPoll?has_content && !(currentPoll.items!?seq_contains(slave.ID))>
                <@rsPoll/>
                <@cmd onclick='pollMe.call(this,${slave.ID})' label="+票"/>
            </#if>
            <@commentButton slave/>
        </li>
    </#if>
</ul>
</#macro>

<#macro rsPoll>
    <#if rsPolled?? || !(currentPoll!?has_content)><#return></#if>
    <#assign rsPolled=true>
    <script>
        function pollMe(route){
            var self=this
            poll && $('#pollbox').load('/poll/'+poll+'/add/'+route+' #pollbox>*',function(){$(self).remove()})
        }
        function removeItem(){
            var route=$('#pollbox :checked').val()            
            poll && route && $('#pollbox').load('/poll/'+poll+'/remove/'+route+' #pollbox>*')
        }
        function selectItem(){
             var route=$('#pollbox :checked').val()
             poll && route &&$('#pollbox').load('/poll/'+poll+'/select/'+route+' #pollbox>*')
        }
        function closePoll(){
            poll && $('#pollbox').load('/poll/'+poll+'/close #pollbox>*')
        }
    </script>
</#macro>

<#macro showSlaveList post>
    <#local slaves=post.slaves!>
    <#local count=post.filteredSlaveCount >
    <div class="box clear">
       <span>
           <strong>${count}个${this.slave.model}</strong>
           <#if "diary"==slaveType!>
            <a href="/plan/show/${post.ID}.shtml#slaves">路线</a>
           <#else>
            <a href="/plan/show;diary/${post.ID}.shtml#slaves">日记</a>
           </#if>
       </span>
        <ul class="tabs right" id="search">
            <#assign searchFilter=post.slaveFilter>
            <@filter4SlaveList post;post>
                <li><@searchableSelect name="author" title="作者" options=post.membersInfo! value=searchFilter.of('author')/></li>
            </@filter4SlaveList> 
        </ul>
    </div>
    <#if slaves?has_content>
        <hr class="space"/>
        <#list slaves as slave>
            <@show1Slave slave/>
            <hr>
        </#list>
        <#if (count>slaves?size)><button onclic="more">more...</button></#if>
    </#if>
</#macro>

<#macro filter4List>
	<li><a href="/route">成熟路线</a></li>
	<@base.filter4List/>
</#macro>

<#macro map post>
		<style>
	<!--
		#textplan .desc{border-top:1px #DDD solid;padding-top:2px;margin-top:2px;font-size:smaller}
		#map{width:950px;height:480px;position:fixed!important;bottom:0;left:0;opacity:0.3;background:yellow}
		#map:hover{opacity:0.8}
		#content div.post{min-height:500px;position:relative;z-index:1}
		#content div.post.hover{}
		#log{display:none}
	-->
	</style>
	<div id="map"></div>
	<script>
       	jQuery(function($){
       		var mapID=${post.ID},
       			lastScrollTop=0,
       			map=$("#map").appendTo("#content")
   					.gmap({center: "beijing"}).data("map")
   					
       		function draw(database){
       			log("drawing")
	       		var seg={trans:TransType.drive, points:[]}, segs=[seg], 
	 				routeLayer=new google.maps.RouteLayer(map)
	 			function traverse(data){
					if(data && data.latlng && data.type==NodeType.path){
						var p=new google.maps.LatLng(data.latlng.lat, data.latlng.lng)
						!('trans' in data) && (data.trans=TransType.drive)
						if(data.trans!=seg.trans){
							if(seg.points.length==0){
								seg.trans=data.trans
								seg.points.push(p)
							}else{
								seg.points.push(p)
								seg={trans:data.trans,points:[p]}
								segs.push(seg)
							}
						}else
							seg.points.push(p)
					}
					
	       			data && ('children' in data) && $.each(data.children,function(){traverse(this)})
	       		}
	       		traverse(database)
	       		routeLayer.path(segs)
	       		routeLayer.fit()
       		}
       		
       		function validate(checking, mapTop, mapBottom, mapHeight){
       			var checkingOffset=checking.offset(),
	   				checkingHeight=checking.height(),
	   				checkingBottom=checkingOffset.top+checkingHeight
	   				
	   			if(checkingBottom<mapTop //checking above map 
	   				|| checkingOffset.top>mapBottom) //checking below map
	   				return 0;
	   				
	   			var top=Math.max(checkingOffset.top, mapTop),
   					bottom=Math.min(checkingBottom, mapBottom),
   					overlappedHeight=bottom-top
   				if(overlappedHeight>=mapHeight/2)
   					return 1;
   					
   				return 2;
       		}
       		
			$(window).scroll(function(event){
				log("scrolling")
				var currentScrollTop=$('body')[0].scrollTop,
					potentials
				if(lastScrollTop<currentScrollTop)//scroll down
					potentials=$('#'+mapID).nextAll('.post').andSelf();
				else if(lastScrollTop>currentScrollTop)//scroll up
					potentials=$('#'+mapID).prevAll('.post').andSelf();
				else
					return;
				lastScrollTop=currentScrollTop;
					
				var count=potentials.length,current
					mapOffset=$('#map').offset(),
	   				mapHeight=$('#map').height(),
	   				mapBottom=mapOffset.top+mapHeight	   				
	   				
				for(var i=0; i<count; i++){
					var current=validate($(potentials[i]), mapOffset.top, mapBottom, mapHeight)
					if(0==current)
						continue;
					else if(1==current){ 
						current=potentials[i];
						break;
					}else{ 
						current=potentials[i+1];
						break;
					}
				}
				
       			if(typeof(current)=='undefined' || current==null || current.id==mapID)
					return;
				$('#'+mapID).removeClass('hover');
				mapID=current.id
       			log("scrolled to "+mapID)
       			draw(current.database)
       			$('#'+mapID).addClass('hover');
				
       		})
       		draw(the(mapID).database)
       		$('#'+mapID).addClass('hover');
       	})
    </script>
</#macro>

   	<#--
    <div id="map"></div>
    <div id="textplan"></div>
    <script>
       	jQuery(function($){
       		var database=${post.route!'null'?js_string};
       		var map=this.map=$("#map").gmap({center: "beijing"}).data("map"),
 				seg={trans:TransType.drive, points:[]}, segs=[seg], 
 				routeLayer=new google.maps.RouteLayer(map),
 				textPlan=$('#textplan'), aText=textPlan
 			function traverse(data){
 				var lastText=aText
 				data.name && (aText=$("<li>"+data.name+"</li>").appendTo(aText))
 				data.desc && $("<div class='desc'>"+data.desc+"</div>").appendTo(aText)
				if(data && data.latlng && data.type==NodeType.path){
					var p=new google.maps.LatLng(data.latlng.lat, data.latlng.lng)
					!('trans' in data) && (data.trans=TransType.drive)
					if(data.trans!=seg.trans){
						if(seg.points.length==0){
							seg.trans=data.trans
							seg.points.push(p)
						}else{
							seg.points.push(p)
							seg={trans:data.trans,points:[p]}
							segs.push(seg)
						}
					}else
						seg.points.push(p)
				}
				
       			data.children && (aText=$("<ul/>").appendTo(aText)) && $.each(data.children,function(){traverse(this)})
       			aText=lastText
       		}
       		traverse(database)
       		routeLayer.path(segs)
       		routeLayer.fit()
       	})
    </script>
    -->